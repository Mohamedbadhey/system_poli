<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Settings - PCMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .section-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        .section-card.disabled {
            opacity: 0.6;
            background-color: #f0f0f0;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .drag-handle {
            cursor: move;
            color: #999;
        }
        .header-image-preview {
            max-width: 300px;
            max-height: 150px;
            border: 2px dashed #ddd;
            padding: 10px;
            border-radius: 8px;
        }
        .nav-tabs .nav-link.active {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-cog"></i> Report Settings</h2>
                    <button class="btn btn-secondary" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>

                <!-- Settings Tabs -->
                <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="header-tab" data-bs-toggle="tab" 
                                data-bs-target="#header-settings" type="button">
                            <i class="fas fa-image"></i> Header Image
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="full-report-tab" data-bs-toggle="tab" 
                                data-bs-target="#full-report-settings" type="button">
                            <i class="fas fa-file-alt"></i> Full Report Sections
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="basic-report-tab" data-bs-toggle="tab" 
                                data-bs-target="#basic-report-settings" type="button">
                            <i class="fas fa-file"></i> Basic Report Sections
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="settingsTabContent">
                    <!-- Header Image Settings -->
                    <div class="tab-pane fade show active" id="header-settings" role="tabpanel">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Report Header Image</h5>
                                <p class="text-muted">This image will appear at the top of all reports (both full and basic)</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Current Header Image</label>
                                    <div id="currentHeaderPreview">
                                        <p class="text-muted">No header image uploaded yet</p>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="headerImageUpload" class="form-label">Upload New Header Image</label>
                                    <input type="file" class="form-control" id="headerImageUpload" 
                                           accept="image/jpeg,image/png,image/gif">
                                    <small class="text-muted">Recommended size: 200x100 pixels. Accepts JPG, PNG, GIF</small>
                                </div>

                                <button class="btn btn-primary" onclick="uploadHeaderImage()">
                                    <i class="fas fa-upload"></i> Upload Header Image
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Full Report Sections -->
                    <div class="tab-pane fade" id="full-report-settings" role="tabpanel">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h5 class="card-title mb-0">Full Report Text Sections</h5>
                                        <p class="text-muted mb-0">Configure sections for comprehensive investigation reports</p>
                                    </div>
                                    <button class="btn btn-success" onclick="addSection('full')">
                                        <i class="fas fa-plus"></i> Add Section
                                    </button>
                                </div>

                                <div id="fullReportSections">
                                    <!-- Sections will be loaded here -->
                                </div>

                                <button class="btn btn-primary mt-3" onclick="saveFullReportSections()">
                                    <i class="fas fa-save"></i> Save Full Report Sections
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Report Sections -->
                    <div class="tab-pane fade" id="basic-report-settings" role="tabpanel">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h5 class="card-title mb-0">Basic Report Text Sections</h5>
                                        <p class="text-muted mb-0">Configure sections for basic investigation reports</p>
                                    </div>
                                    <button class="btn btn-success" onclick="addSection('basic')">
                                        <i class="fas fa-plus"></i> Add Section
                                    </button>
                                </div>

                                <div id="basicReportSections">
                                    <!-- Sections will be loaded here -->
                                </div>

                                <button class="btn btn-primary mt-3" onclick="saveBasicReportSections()">
                                    <i class="fas fa-save"></i> Save Basic Report Sections
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const API_BASE = '/api/admin/report-settings';
        let fullReportSections = {};
        let basicReportSections = {};

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadReportSettings();
        });

        // Load all report settings
        function loadReportSettings() {
            fetch(API_BASE)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Load header image
                        if (data.data.header_image) {
                            showHeaderImage(data.data.header_image);
                        }

                        // Load sections
                        fullReportSections = data.data.full_report_sections || {};
                        basicReportSections = data.data.basic_report_sections || {};

                        renderSections('full', fullReportSections);
                        renderSections('basic', basicReportSections);
                    }
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                    showToast('Failed to load settings', 'error');
                });
        }

        // Show header image preview
        function showHeaderImage(imagePath) {
            const imageUrl = `/uploads/${imagePath}`;
            document.getElementById('currentHeaderPreview').innerHTML = `
                <img src="${imageUrl}" class="header-image-preview" alt="Report Header">
                <button class="btn btn-sm btn-danger mt-2" onclick="removeHeaderImage()">
                    <i class="fas fa-trash"></i> Remove
                </button>
            `;
        }

        // Upload header image
        function uploadHeaderImage() {
            const fileInput = document.getElementById('headerImageUpload');
            const file = fileInput.files[0];

            if (!file) {
                showToast('Please select an image file', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('header_image', file);

            fetch(`${API_BASE}/upload-header`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('Header image uploaded successfully', 'success');
                    showHeaderImage(data.data.image_path);
                    fileInput.value = '';
                } else {
                    showToast('Failed to upload image', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Upload failed', 'error');
            });
        }

        // Render sections
        function renderSections(type, sections) {
            const container = document.getElementById(`${type}ReportSections`);
            container.innerHTML = '';

            // Convert to array and sort by order
            const sectionsArray = Object.entries(sections).map(([key, section]) => ({
                key: key,
                ...section
            })).sort((a, b) => (a.order || 0) - (b.order || 0));

            sectionsArray.forEach((section, index) => {
                container.innerHTML += createSectionCard(type, section, index);
            });
        }

        // Create section card HTML
        function createSectionCard(type, section, index) {
            const isDisabled = !section.enabled;
            return `
                <div class="section-card ${isDisabled ? 'disabled' : ''}" data-section-key="${section.key}">
                    <div class="section-header">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-grip-vertical drag-handle me-2"></i>
                            <h6 class="mb-0">${section.title}</h6>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="toggleSection('${type}', '${section.key}')">
                                <i class="fas fa-${section.enabled ? 'eye-slash' : 'eye'}"></i>
                                ${section.enabled ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteSection('${type}', '${section.key}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Section Title</label>
                        <input type="text" class="form-control form-control-sm" 
                               value="${section.title}" 
                               onchange="updateSectionField('${type}', '${section.key}', 'title', this.value)">
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Order</label>
                        <input type="number" class="form-control form-control-sm" 
                               value="${section.order || index + 1}" 
                               onchange="updateSectionField('${type}', '${section.key}', 'order', parseInt(this.value))">
                    </div>
                    <div>
                        <label class="form-label small">Template Text</label>
                        <textarea class="form-control form-control-sm" rows="3" 
                                  onchange="updateSectionField('${type}', '${section.key}', 'template', this.value)">${section.template || ''}</textarea>
                        <small class="text-muted">This text will appear as guidance in the report</small>
                    </div>
                </div>
            `;
        }

        // Update section field
        function updateSectionField(type, key, field, value) {
            const sections = type === 'full' ? fullReportSections : basicReportSections;
            if (sections[key]) {
                sections[key][field] = value;
            }
        }

        // Toggle section enabled/disabled
        function toggleSection(type, key) {
            const sections = type === 'full' ? fullReportSections : basicReportSections;
            if (sections[key]) {
                sections[key].enabled = !sections[key].enabled;
                renderSections(type, sections);
            }
        }

        // Delete section
        function deleteSection(type, key) {
            if (!confirm('Are you sure you want to delete this section?')) {
                return;
            }

            const sections = type === 'full' ? fullReportSections : basicReportSections;
            delete sections[key];
            renderSections(type, sections);
        }

        // Add new section
        function addSection(type) {
            const title = prompt('Enter section title:');
            if (!title) return;

            const key = title.toLowerCase().replace(/\s+/g, '_');
            const sections = type === 'full' ? fullReportSections : basicReportSections;

            sections[key] = {
                title: title,
                enabled: true,
                order: Object.keys(sections).length + 1,
                template: ''
            };

            renderSections(type, sections);
        }

        // Save full report sections
        function saveFullReportSections() {
            saveSections('full', fullReportSections, 'update-full-sections');
        }

        // Save basic report sections
        function saveBasicReportSections() {
            saveSections('basic', basicReportSections, 'update-basic-sections');
        }

        // Save sections to server
        function saveSections(type, sections, endpoint) {
            fetch(`${API_BASE}/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sections: sections
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast(`${type === 'full' ? 'Full' : 'Basic'} report sections saved successfully`, 'success');
                } else {
                    showToast('Failed to save sections', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Save failed', 'error');
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            // Simple alert for now, can be replaced with a proper toast library
            alert(message);
        }
    </script>
</body>
</html>
