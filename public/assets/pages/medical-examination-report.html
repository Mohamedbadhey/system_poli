<!DOCTYPE html>
<html lang="so">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAASHIDA DHAKHTARKA EE DHAAWA-MUUJINTA</title>
    <link rel="stylesheet" href="../css/medical-report-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/medical-examination-form-db.js"></script>
    <style>
        .print-button-container {
            text-align: center;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .print-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 0 10px;
        }
        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .print-btn i {
            margin-right: 8px;
        }
        .save-status {
            display: inline-block;
            margin-left: 20px;
            color: #10b981;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .signature-canvas {
            border: 2px solid #000;
            border-radius: 4px;
            cursor: crosshair;
            background: white;
            width: 100%;
            height: 120px;
            display: block;
            margin: 10px 0;
        }
        .signature-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .clear-sig-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .clear-sig-btn:hover {
            background: #dc2626;
        }
        @media print {
            .print-button-container {
                display: none;
            }
            .signature-canvas {
                display: none;
            }
            .signature-controls {
                display: none;
            }
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="print-button-container">
        <button class="print-btn" id="newFormBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <i class="fas fa-plus-circle"></i> New Form
        </button>
        <button class="print-btn" id="selectCaseBtn" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
            <i class="fas fa-folder-open"></i> Select Case
        </button>
        <button class="print-btn" id="saveDraftBtn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <i class="fas fa-save"></i> Save Form
        </button>
        <button class="print-btn" id="loadSavedFormBtn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
            <i class="fas fa-folder-open"></i> My Forms
        </button>
        <button class="print-btn" id="printFormBtn">
            <i class="fas fa-print"></i> Print
        </button>
        <span id="saveStatus" class="save-status" style="display: none;">Ready</span>
        <span id="linkedCaseInfo" style="margin-left: 15px; padding: 5px 10px; background: #10b981; color: white; border-radius: 5px; font-size: 12px; display: none;">
            <i class="fas fa-link"></i> <span id="linkedCaseText"></span>
        </span>
    </div>

    <!-- Saved Forms Modal -->
    <div id="savedFormsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 1000px; margin: 50px auto; background: white; border-radius: 10px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #333;"><i class="fas fa-folder-open"></i> My Saved Forms</h2>
                <button onclick="closeSavedForms()" style="background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            
            <div id="savedFormsListContainer" style="max-height: 600px; overflow-y: auto;">
                <div style="padding: 20px; text-align: center; color: #999;">
                    <i class="fas fa-spinner fa-spin"></i> Loading saved forms...
                </div>
            </div>
        </div>
    </div>

    <!-- Case Selection Modal -->
    <div id="caseSelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 900px; margin: 50px auto; background: white; border-radius: 10px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #333;"><i class="fas fa-folder-open"></i> Select Case for Medical Examination</h2>
                <button onclick="closeCaseSelection()" style="background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="caseSearchInput" placeholder="Search by case number, victim, or accused..." 
                    style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;"
                    onkeyup="filterCases()">
            </div>

            <div id="caseListContainer" style="max-height: 500px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px;">
                <div style="padding: 20px; text-align: center; color: #999;">
                    <i class="fas fa-spinner fa-spin"></i> Loading cases...
                </div>
            </div>
        </div>
    </div>

    <!-- Party Selection Modal -->
    <div id="partySelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; overflow-y: auto;">
        <div style="max-width: 700px; margin: 100px auto; background: white; border-radius: 10px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: #333;"><i class="fas fa-user-md"></i> Select Party for Medical Examination</h2>
            <p style="color: #666; margin-bottom: 20px;">Choose which person this medical examination is for:</p>
            
            <div id="partyListContainer">
                <!-- Parties will be loaded here -->
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closePartySelection()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    <div class="report-container">
        <!-- PAGE 1 -->
        <div class="page" data-page="Page 1 of 4">
            <div id="headerImageContainer">
                <!-- Header image will be loaded here -->
                <img id="reportHeaderImage" src="" alt="Report Header" style="width: 100%; height: 80px; display: block; object-fit: fill; margin: 0; padding: 0;">
            </div>
            <div class="header">
                <h2>XAASHIDA DHAKHTARKA EE DHAAWA-MUUJINTA</h2>
                <div class="header-info">
                    <div class="info-row">
                        <span>Taariikh: <input type="date" name="report_date" id="reportDate" style="border:none; border-bottom:1px solid #000; font-size:14px; width:150px;"></span>
                        <span>X,C,S,/440</span>
                    </div>
                    <div class="info-row">
                        <span>NO: <input type="text" name="case_number" id="caseNumber" style="border:none; border-bottom:1px solid #000; font-size:14px; width:150px;" placeholder="BOL/61"></span>
                        <span>BOL/61</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    QAYBTA 1AAD (WAA IN UU BOOLISKU BUUXIYO IYADA OO LABO NUQUL KA KOOBAN)
                </div>

                <table class="compact-table">
                    <tr>
                        <th style="width: 30%;">Faahfaahin</th>
                        <th style="width: 70%;">Macluumaad</th>
                    </tr>
                    <tr>
                        <td>Ku: Isbitaalka</td>
                        <td><input type="text" name="hospital_name" id="hospitalName"></td>
                    </tr>
                    <tr>
                        <td>Magaca Dhibanaha</td>
                        <td><input type="text" name="victim_name" id="victimName"></td>
                    </tr>
                    <tr>
                        <td>Magaca Eedeysanaha</td>
                        <td><input type="text" name="accused_name" id="accusedName"></td>
                    </tr>
                    <tr>
                        <td>Daʼda</td>
                        <td><input type="text" name="age" id="age"></td>
                    </tr>
                    <tr>
                        <td>Xaafadda, Degmada / Magaalada</td>
                        <td><input type="text" name="location" id="location"></td>
                    </tr>
                    <tr>
                        <td>Taariikhda lyo Wakhtiga Danbigu Dhacay</td>
                        <td><input type="text" name="incident_datetime" id="incidentDateTime"></td>
                    </tr>
                    <tr>
                        <td>Taariikhda lyo Wakhtiga Warbixinta Booliska</td>
                        <td><input type="text" name="police_report_datetime" id="policeReportDateTime"></td>
                    </tr>
                    <tr>
                        <td>Faahfaahin Kooban Oo Ku Saabsan Danbiga Dhacay</td>
                        <td><textarea rows="2" name="crime_description" id="crimeDescription"></textarea></td>
                    </tr>
                    <tr>
                        <td>Caddee Haddii Uu Afduub Jiro</td>
                        <td><input type="text" name="kidnapping_status" id="kidnappingStatus"></td>
                    </tr>
                    <tr>
                        <td>Maalinta lyo Taariikhda Loo Gudbiyay Isbitaalka</td>
                        <td><input type="text" name="hospital_submission_date" id="hospitalSubmissionDate"></td>
                    </tr>
                    <tr>
                        <td>Qaybta Booliska [Saldhigga]</td>
                        <td><input type="text" name="police_station" id="policeStation"></td>
                    </tr>
                    <tr>
                        <td>Lambarka OOBBIGA Booliska</td>
                        <td><input type="text" name="ob_number" id="obNumber"></td>
                    </tr>
                    <tr>
                        <td>Magaca Sarkaalka Booliska Ee Codsiga Sameynaya</td>
                        <td><input type="text" name="officer_name" id="officerName"></td>
                    </tr>
                    <tr>
                        <td>Lambarkiisa Ama Darajadiisa</td>
                        <td><input type="text" name="officer_rank" id="officerRank"></td>
                    </tr>
                    <tr>
                        <td>Jagada Uu Hayo</td>
                        <td><input type="text" name="officer_position" id="officerPosition"></td>
                    </tr>
                    <tr>
                        <td>Lambarka Telefoonka</td>
                        <td><input type="text" name="officer_phone" id="officerPhone"></td>
                    </tr>
                    <tr>
                        <td>Saxiixa (Officer Signature)</td>
                        <td>
                            <canvas id="officerSignatureCanvas" class="signature-canvas" style="height: 60px;"></canvas>
                            <button type="button" class="clear-sig-btn" onclick="clearOfficerSignature()" style="margin-top: 3px;">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="section">
                <div class="section-title">QAYBTA II. FAAHFAAHINTA CAAFIMAADKA (WAA INUU ISBITAALKU BUUXIYO LABO NUQUL)</div>

                <table class="compact-table">
                    <tr>
                        <th colspan="2" style="text-align: center;">QAYBTA A - MACLUUMAADKA BUKAANKA</th>
                    </tr>
                    <tr>
                        <td style="width: 30%;">Taariikh</td>
                        <td style="width: 70%;"><input type="text" name="exam_date"></td>
                    </tr>
                    <tr>
                        <td>Tixraac</td>
                        <td><input type="text" name="reference"></td>
                    </tr>
                    <tr>
                        <td>Magaca Bukaanka</td>
                        <td><input type="text" name="patient_name"></td>
                    </tr>
                    <tr>
                        <td>Lr. Galka ee isbitaalka</td>
                        <td><input type="text" name="admission_number"></td>
                    </tr>
                    <tr>
                        <td>Taariikhda Baaritaanka</td>
                        <td><input type="text" name="examination_date"></td>
                    </tr>
                    <tr>
                        <td>Wakhtiga Baaritaanka</td>
                        <td><input type="text" name="examination_time"></td>
                    </tr>
                </table>
            </div>
            <div class="page-number">Page 1 of 4</div>
        </div>

        <!-- PAGE 2 -->
        <div class="page" data-page="Page 2 of 4">
            <div class="section">
                <div class="section-title">QAYBTA FAAHFAAHINTA TACADDIGA JINSIGA</div>

                <table class="compact-table">
                    <tr>
                        <th style="width: 35%;">Baaritaanka</th>
                        <th style="width: 65%;">Natiijada</th>
                    </tr>
                    <tr>
                        <td>1. Nooca tacaddiga jinsi ee la gaystay</td>
                        <td><textarea rows="2" name="assault_type"></textarea></td>
                    </tr>
                    <tr>
                        <td>2. Biyo isku rusheeyay, qubaystay ama kaadiyay</td>
                        <td><textarea rows="1" name="post_assault_hygiene"></textarea></td>
                    </tr>
                    <tr>
                        <td>3. Nooca falka galmo (afka, xubinta taranka, futada)</td>
                        <td><textarea rows="2" name="assault_details"></textarea></td>
                    </tr>
                    <tr>
                        <td>4. Faahfaahin shaqsi-ahaaneed</td>
                        <td><textarea rows="2" name="personal_history"></textarea></td>
                    </tr>
                    <tr>
                        <td>5. Taariikhda cudurrada haweenka</td>
                        <td><textarea rows="1" name="gynecological_history"></textarea></td>
                    </tr>
                    <tr>
                        <td>b) Uur ma leedahay? / Shinka uurka</td>
                        <td><input type="checkbox" name="pregnant_yes"> Haa <input type="checkbox" name="pregnant_no"> Maya | Shinka: <input type="text" name="pregnancy_months" style="width: 60px;"></td>
                    </tr>
                    <tr>
                        <td>t) Waqtigii ugu dambeysay caadada</td>
                        <td><input type="text" name="last_period"></td>
                    </tr>
                    <tr>
                        <td>j) Imisaa caruura ayaa dhashay</td>
                        <td><input type="text" name="children_count"></td>
                    </tr>
                    <tr>
                        <td>6. Dhererka / Cufnaanka / Dhismaha Jirka</td>
                        <td>
                            Dhererka: <input type="text" name="height" style="width: 60px;"> | 
                            Cufnaanka: <input type="text" name="weight" style="width: 60px;"> | 
                            Dhismaha: <input type="text" name="body_build" style="width: 80px;">
                        </td>
                    </tr>
                    <tr>
                        <td>7. Daroogaysan/cabsan yahay?</td>
                        <td><input type="checkbox" name="intoxicated_yes"> Haa <input type="checkbox" name="intoxicated_no"> Maya</td>
                    </tr>
                    <tr>
                        <td>8. Calaamadaha Muhiimka ah</td>
                        <td>
                            Heerkulka: <input type="text" name="temperature" style="width: 50px;"> | 
                            Wadna-garaac: <input type="text" name="pulse" style="width: 50px;"> | 
                            Dhiiga: <input type="text" name="blood_pressure" style="width: 60px;"> | 
                            Neefsashada: <input type="text" name="respiration" style="width: 50px;">
                        </td>
                    </tr>
                    <tr>
                        <td>9. Indhaha - dhiig fadhiistay (ceejin)</td>
                        <td>
                            <input type="checkbox" name="eyes_yes"> Haa <input type="checkbox" name="eyes_no"> Maya<br>
                            <textarea rows="1" name="eyes_details"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>10. Afka/Far Faruuryaha (diir-kac/murxid/dilaac)</td>
                        <td>
                            <input type="checkbox" name="mouth_yes"> Haa <input type="checkbox" name="mouth_no"> Maya<br>
                            <textarea rows="1" name="mouth_details"></textarea>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="page-number">Page 2 of 4</div>
        </div>

        <!-- PAGE 3 -->
        <div class="page" data-page="Page 3 of 4">
            <div class="section">
                <div class="section-title">BAARITAANKA JIRKA IYO URURINTA CADDAYNTA</div>
                
                <table class="compact-table">
                    <tr>
                        <th style="width: 40%;">Qaybta Jirka</th>
                        <th style="width: 60%;">Natiijada</th>
                    </tr>
                    <tr>
                        <td>11. Maqaarka madaxa (jeexdin-xulan iwm)</td>
                        <td>
                            <input type="checkbox" name="scalp_yes"> Haa <input type="checkbox" name="scalp_no"> Maya<br>
                            <textarea rows="1" name="scalp_details"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>12. Qoorta (murxid/jeexdin-xulan iwm)</td>
                        <td>
                            <input type="checkbox" name="neck_yes"> Haa <input type="checkbox" name="neck_no"> Maya<br>
                            <textarea rows="1" name="neck_details"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>c) Dheecaan (swab) - Marinka ilmaha / Dabada</td>
                        <td>
                            Marinka: <input type="checkbox" name="swab_vaginal_yes"> Haa <input type="checkbox" name="swab_vaginal_no"> Maya | 
                            Dabada: <input type="checkbox" name="swab_anal_yes"> Haa <input type="checkbox" name="swab_anal_no"> Maya<br>
                            <textarea rows="1" name="swab_details"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>t) Marinka Ilmaha/dabada - Natiijada</td>
                        <td>
                            <input type="checkbox" name="finding_murux"> Murux 
                            <input type="checkbox" name="finding_dilaac"> Dilaac 
                            <input type="checkbox" name="finding_dhiig_gaduudan"> Dhiig gaduudan 
                            <input type="checkbox" name="finding_dhiig_hoorsi"> Dhiig hoorsi<br>
                            <textarea rows="1" name="findings_details"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>j) Baaritaan dabada ma samaysay</td>
                        <td>
                            <input type="checkbox" name="anal_exam_yes"> Haa <input type="checkbox" name="anal_exam_no"> Maya<br>
                            <textarea rows="1" name="anal_exam_details"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>Masawir ma laga qaaday dhaawacyada?</td>
                        <td><input type="checkbox" name="photos_yes"> Haa <input type="checkbox" name="photos_no"> Maya</td>
                    </tr>
                </table>

                <div class="section-title" style="margin-top: 10px;">DIIWAANKA NAAMUUNADAHA FOORANSIGA</div>
                
                <table class="compact-table">
                    <tr>
                        <th style="width: 50%;">Naamuunadaha</th>
                        <th style="width: 50%;">Macluumaad</th>
                    </tr>
                    <tr>
                        <td>Dhiig (DNA)</td>
                        <td><input type="text" name="evidence_dna"></td>
                    </tr>
                    <tr>
                        <td>Xagashada ciddiyaha</td>
                        <td><input type="text" name="evidence_vaginal_swab"></td>
                    </tr>
                    <tr>
                        <td>Shanlo</td>
                        <td><input type="text" name="evidence_pubic_hair"></td>
                    </tr>
                    <tr>
                        <td>Ilaali Timaha Shuunka</td>
                        <td><input type="text" name="evidence_body_hair"></td>
                    </tr>
                    <tr>
                        <td>Ilaali timaha madaxa</td>
                        <td><input type="text" name="evidence_head_hair"></td>
                    </tr>
                    <tr>
                        <td>Dheecaan Shisheeye</td>
                        <td><input type="text" name="evidence_foreign_swab"></td>
                    </tr>
                    <tr>
                        <td>Timo Shisheeye</td>
                        <td><input type="text" name="evidence_foreign_hair"></td>
                    </tr>
                    <tr>
                        <td>Warqadda qabashada</td>
                        <td><input type="text" name="evidence_clothing"></td>
                    </tr>
                    <tr>
                        <td>Shayga Dhuqa Dhiiga</td>
                        <td><input type="text" name="evidence_blood_stain"></td>
                    </tr>
                </table>
            </div>
            <div class="page-number">Page 3 of 4</div>
        </div>

        <!-- PAGE 4 -->
        <div class="page" data-page="Page 4 of 4">
            <div class="section">
                <div class="section-title">MACLUUMAADKA DHAKHTARKA</div>
                
                <table class="compact-table">
                    <tr>
                        <th style="width: 30%;">Faahfaahin</th>
                        <th style="width: 70%;">Macluumaad</th>
                    </tr>
                    <tr>
                        <td>Nooca Dhakhtarka</td>
                        <td>
                            <input type="checkbox" name="doctor_senior"> Dakhtar sare | 
                            <input type="checkbox" name="doctor_experienced"> Dakhtar Qibrad 5+ Sano
                        </td>
                    </tr>
                    <tr>
                        <td>Magaca</td>
                        <td><input type="text" name="doctor_name"></td>
                    </tr>
                    <tr>
                        <td>Lambarka Telefoonka</td>
                        <td><input type="text" name="doctor_phone"></td>
                    </tr>
                    <tr>
                        <td>Email</td>
                        <td><input type="text" name="doctor_email"></td>
                    </tr>
                    <tr>
                        <td>Saxiix (Doctor Signature)</td>
                        <td>
                            <canvas id="doctorSignatureCanvas" class="signature-canvas" style="height: 60px;"></canvas>
                            <button type="button" class="clear-sig-btn" onclick="clearDoctorSignature()" style="margin-top: 3px;">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="section">
                <div class="section-title">QAYBTA III. FAAHFAAHINTA DHAAWACA</div>

                <table class="compact-table">
                    <tr>
                        <th style="width: 35%;">Faahfaahin</th>
                        <th style="width: 65%;">Macluumaad</th>
                    </tr>
                    <tr>
                        <td>a) Goobta dhaawaca</td>
                        <td>
                            <input type="checkbox" name="injury_head_neck"> Madaxa/Qoorta | 
                            <input type="checkbox" name="injury_chest_abdomen"> Xabadka/Caloosha | 
                            <input type="checkbox" name="injury_upper_limbs"> Laxaadka Kore | 
                            <input type="checkbox" name="injury_lower_limbs"> Laxaadka Hoose | 
                            <input type="checkbox" name="injury_other"> Kale<br>
                            <textarea rows="2" name="injury_description"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>b) Qiyaasta inta uu dhaawacu jiro</td>
                        <td><input type="text" name="injury_age"></td>
                    </tr>
                    <tr>
                        <td>c) Nooca qalabka keenay dhaawaca</td>
                        <td><input type="text" name="weapon_type"></td>
                    </tr>
                    <tr>
                        <td>d) Dawayn ka hor baaritaanka</td>
                        <td><textarea rows="1" name="prior_treatment"></textarea></td>
                    </tr>
                    <tr>
                        <td>e) Natiijada baaritaanka iyo nooca dhaawaca</td>
                        <td>
                            <input type="checkbox" name="injury_minor"> * Fudud | 
                            <input type="checkbox" name="injury_serious"> ** Culus | 
                            <input type="checkbox" name="injury_very_serious"> *** Aad u culus<br>
                            <textarea rows="2" name="medical_assessment"></textarea>
                        </td>
                    </tr>
                </table>

                <div class="definitions" style="font-size: 8px; padding: 8px;">
                    <strong>*Dhaawac Fudud:</strong> Bukaan jirka ku saabsan oo fudud<br>
                    <strong>**Dhaawac Culus:</strong> [b] Halis nafeed ama 40+ maalmood shaqo darro [t] Itaal darro joogto ah dareen/xubin [i] Ilig la rido<br>
                    <strong>***Dhaawac Aad u Culus:</strong> [b] Bukaan aan la daaweyn karin [t] Dareen luma [j] Xubin ama addin go'a/naafo [x] Foolxumo waji ku harta [kh] Dhimasho
                </div>
            </div>

            <!-- Verification Section -->
            <div class="section" style="margin-top: 15px;">
                <div class="section-title">XAQIIJINTA WARBIXINTA (REPORT VERIFICATION)</div>
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-top: 10px;">
                    <!-- QR Code Section -->
                    <div style="flex: 0 0 120px; text-align: center; border: 2px solid #000; padding: 10px;">
                        <div id="qrCodeContainer" style="width: 100px; height: 100px; margin: 0 auto; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #999;">
                            <div style="text-align: center;">
                                <i class="fas fa-qrcode" style="font-size: 24px; color: #ccc;"></i>
                                <div style="font-size: 8px; margin-top: 5px;">Save to generate</div>
                            </div>
                        </div>
                        <div style="font-size: 8px; margin-top: 5px; font-weight: bold;">Scan for Verification</div>
                    </div>

                    <!-- Authorized Signatures Section -->
                    <div style="flex: 1;">
                        <table class="compact-table">
                            <tr>
                                <th colspan="2" style="text-align: center; background-color: #e8e8e8;">SAXIIXAHA XAQA AH (AUTHORIZED SIGNATURES)</th>
                            </tr>
                            <tr>
                                <td style="width: 50%;">
                                    <strong>Magaca Qofka Xaqiijinaya:</strong><br>
                                    <input type="text" name="verifier_name" style="width: 100%; margin-top: 5px;" placeholder="Full Name">
                                </td>
                                <td style="width: 50%;">
                                    <strong>Jagada:</strong><br>
                                    <input type="text" name="verifier_position" style="width: 100%; margin-top: 5px;" placeholder="Position/Title">
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <strong>Saxiixa:</strong><br>
                                    <canvas id="verifierSignatureCanvas" class="signature-canvas" style="height: 60px; margin-top: 5px;"></canvas>
                                    <button type="button" class="clear-sig-btn" onclick="clearVerifierSignature()" style="margin-top: 3px;">
                                        <i class="fas fa-eraser"></i> Clear
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>Taariikhda:</strong><br>
                                    <input type="date" name="verification_date" style="width: 100%; margin-top: 5px;">
                                </td>
                                <td>
                                    <strong>Waqtiga:</strong><br>
                                    <input type="time" name="verification_time" style="width: 100%; margin-top: 5px;">
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div style="margin-top: 10px; padding: 8px; background-color: #f9f9f9; border: 1px solid #ccc; font-size: 8px;">
                    <strong>Ogeysiis:</strong> Warbixintan waxaa xaqiijiyay qof sharci ahaan u xilsaaran. QR Code-ka kor ku yaal wuxuu hubinayaa saxnimada iyo asal ahaan warbixinta.
                    <br><strong>Notice:</strong> This report has been verified by an authorized person. The QR code above verifies the authenticity and integrity of this report.
                </div>
            </div>

            <div class="page-number">Page 4 of 4</div>
        </div>
    </div>
    
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/medical-examination-form.js?v=4"></script>
    
    <script>
        // Check if viewing a saved form via public link (from QR code)
        document.addEventListener('DOMContentLoaded', function() {
            // Extract form ID from URL path
            const pathParts = window.location.pathname.split('/');
            const publicIndex = pathParts.indexOf('public');
            
            if (publicIndex !== -1 && pathParts[publicIndex + 1]) {
                const formId = pathParts[publicIndex + 1];
                loadPublicForm(formId);
            }
        });
        
        async function loadPublicForm(formId) {
            try {
                console.log('Loading public medical form:', formId);
                
                // Show loading overlay
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loadingOverlay';
                loadingOverlay.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(255,255,255,0.95); z-index: 9998;
                    display: flex; align-items: center; justify-content: center;
                    font-size: 20px; color: #667eea;
                `;
                loadingOverlay.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> Loading medical form...</div>';
                document.body.appendChild(loadingOverlay);
                
                // Fetch form from public endpoint
                const response = await fetch(`${API_BASE_URL}/medical-forms/public/${formId}`);
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    const formData = result.data;
                    console.log('Medical form data loaded:', formData);
                    
                    // Populate case number
                    if (formData.case_number) {
                        const caseNumberField = document.getElementById('caseNumber');
                        if (caseNumberField) caseNumberField.value = formData.case_number;
                    }
                    
                    // Populate patient name
                    if (formData.patient_name) {
                        const patientNameField = document.getElementById('patientName');
                        if (patientNameField) patientNameField.value = formData.patient_name;
                    }
                    
                    // Parse and populate form_data JSON
                    if (formData.form_data) {
                        let parsedData;
                        try {
                            parsedData = typeof formData.form_data === 'string' ? JSON.parse(formData.form_data) : formData.form_data;
                        } catch (e) {
                            console.error('Error parsing form_data:', e);
                            parsedData = formData.form_data;
                        }
                        
                        // Populate all fields from form_data
                        if (parsedData) {
                            Object.keys(parsedData).forEach(key => {
                                const element = document.getElementById(key);
                                if (element) {
                                    if (element.type === 'checkbox') {
                                        element.checked = parsedData[key] === true || parsedData[key] === 'true' || parsedData[key] === 1;
                                    } else if (element.type === 'radio') {
                                        if (element.value === parsedData[key]) {
                                            element.checked = true;
                                        }
                                    } else {
                                        element.value = parsedData[key];
                                    }
                                }
                            });
                        }
                    }
                    
                    // Make form read-only (viewing mode)
                    const allInputs = document.querySelectorAll('input, textarea, select, button');
                    allInputs.forEach(input => {
                        if (input.tagName === 'BUTTON') {
                            // Hide all buttons except print
                            if (!input.textContent.includes('Print') && !input.textContent.includes('Daabac')) {
                                input.style.display = 'none';
                            }
                        } else {
                            input.disabled = true;
                            input.style.backgroundColor = '#f9fafb';
                            input.style.cursor = 'not-allowed';
                        }
                    });
                    
                    // Add a banner to indicate view-only mode
                    const banner = document.createElement('div');
                    banner.className = 'no-print';
                    banner.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white; padding: 12px 20px;
                        text-align: center; z-index: 9999;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                        font-weight: 500;
                    `;
                    banner.innerHTML = `
                        <i class="fas fa-eye"></i> 
                        <span style="margin-left: 8px;">Viewing Medical Examination Form (Read-Only)</span>
                        <span style="margin-left: 20px; font-size: 0.9em; opacity: 0.95; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px;">
                            Case: ${formData.case_number || 'N/A'} | Patient: ${formData.patient_name || 'N/A'}
                        </span>
                    `;
                    document.body.insertBefore(banner, document.body.firstChild);
                    
                    // Adjust first page padding to account for banner
                    const firstPage = document.querySelector('.report-page');
                    if (firstPage) {
                        firstPage.style.marginTop = '60px';
                    }
                    
                    // Remove loading overlay
                    loadingOverlay.remove();
                    
                    // Show success notification
                    setTimeout(() => {
                        showToast('✓ Medical form loaded successfully', 'success');
                    }, 300);
                    
                } else {
                    throw new Error(result.message || 'Failed to load medical form');
                }
                
            } catch (error) {
                console.error('Error loading public medical form:', error);
                document.body.innerHTML = `
                    <div style="max-width: 600px; margin: 100px auto; text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 72px; color: #ef4444; margin-bottom: 24px;"></i>
                        <h2 style="font-size: 28px; color: #1f2937; margin-bottom: 16px; font-weight: 600;">Medical Form Not Found</h2>
                        <p style="font-size: 16px; color: #6b7280; margin-bottom: 32px; line-height: 1.6;">${error.message}</p>
                        <button onclick="window.history.back()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px 32px; font-size: 16px; border-radius: 8px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 12px rgba(102,126,234,0.4);">
                            <i class="fas fa-arrow-left"></i> Go Back
                        </button>
                    </div>
                `;
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'no-print';
            toast.style.cssText = `
                position: fixed; top: 70px; right: 20px; padding: 16px 24px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000; animation: slideInRight 0.3s ease;
                font-weight: 500;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>

