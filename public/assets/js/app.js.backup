// ============================================
// Main Application Logic
// ============================================

let currentUser = null;

// Initialize application
$(document).ready(function() {
    // Check authentication
    if (!checkAuth()) {
        return;
    }
    
    // Load user data
    currentUser = getCurrentUser();
    
    if (currentUser) {
        initializeApp();
    }
});

// Initialize application
function initializeApp() {
    // Set user name
    $('#userName').text(currentUser.full_name);
    
    // Load navigation based on role
    loadNavigation();
    
    // Load notifications
    loadNotifications();
    
    // Setup event listeners
    setupEventListeners();
    
    // Setup URL routing
    setupRouting();
    
    // Load page based on URL or default to dashboard
    loadPageFromURL();
}

// Setup event listeners
function setupEventListeners() {
    // Sidebar toggle
    $('#sidebarToggle').on('click', function() {
        $('#sidebar').toggleClass('show');
    });
    
    // User dropdown
    $('#userBtn').on('click', function(e) {
        e.stopPropagation();
        $('#userDropdown').toggleClass('show');
    });
    
    // Notification dropdown
    $('#notificationBtn').on('click', function(e) {
        e.stopPropagation();
        $('#notificationDropdown').toggleClass('show');
    });
    
    // Close dropdowns when clicking outside
    $(document).on('click', function() {
        $('.dropdown-menu').removeClass('show');
    });
    
    // Global search
    $('#globalSearch').on('keypress', function(e) {
        if (e.which === 13) {
            performGlobalSearch($(this).val());
        }
    });
    
    // Navigation click handlers
    $(document).on('click', '.nav-item', function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        
        // Update active state
        $('.nav-item').removeClass('active');
        $(this).addClass('active');
        
        // Load the page and update URL
        navigateToPage(page);
    });
}

// Load navigation based on user role
function loadNavigation() {
    const nav = $('#sidebarNav');
    nav.empty();
    
    const role = currentUser.role;
    
    // Common navigation items
    nav.append(createNavItem('dashboard', 'Dashboard', 'fas fa-home', true));
    
    // Role-specific navigation
    if (role === USER_ROLES.SUPER_ADMIN) {
        nav.append(createNavItem('users', 'User Management', 'fas fa-users'));
        nav.append(createNavItem('centers', 'Police Centers', 'fas fa-building'));
        nav.append(createNavItem('categories', 'Categories', 'fas fa-tags'));
        nav.append(createNavItem('audit-logs', 'Audit Logs', 'fas fa-clipboard-list'));
        nav.append(createNavItem('reports', 'System Reports', 'fas fa-chart-bar'));
    }
    
    if (role === USER_ROLES.ADMIN || role === USER_ROLES.SUPER_ADMIN) {
        nav.append(createNavItem('pending-cases', 'Pending Approval', 'fas fa-clock'));
        nav.append(createNavItem('all-cases', 'All Cases', 'fas fa-folder-open'));
        nav.append(createNavItem('cases-by-category', 'Cases by Category', 'fas fa-folder-tree'));
        nav.append(createNavItem('assignments', 'Assignments', 'fas fa-tasks'));
        nav.append(createNavItem('custody', 'Custody Management', 'fas fa-user-lock'));
        if (role === USER_ROLES.ADMIN) {
            nav.append(createNavItem('categories', 'Categories', 'fas fa-tags'));
        }
    }
    
    if (role === USER_ROLES.OB_OFFICER || hasAnyRole([USER_ROLES.ADMIN, USER_ROLES.SUPER_ADMIN])) {
        nav.append(createNavItem('ob-entry', 'OB Entry', 'fas fa-file-alt'));
        nav.append(createNavItem('my-cases', 'My Cases', 'fas fa-briefcase'));
        if (role === USER_ROLES.OB_OFFICER) {
            nav.append(createNavItem('cases-by-category', 'Cases by Category', 'fas fa-folder-tree'));
        }
    }
    
    if (role === USER_ROLES.INVESTIGATOR || hasAnyRole([USER_ROLES.ADMIN, USER_ROLES.SUPER_ADMIN])) {
        nav.append(createNavItem('investigations', 'My Investigations', 'fas fa-search'));
        nav.append(createNavItem('evidence', 'Evidence Management', 'fas fa-box'));
        if (role === USER_ROLES.INVESTIGATOR) {
            nav.append(createNavItem('cases-by-category', 'Cases by Category', 'fas fa-folder-tree'));
            nav.append(createNavItem('report-settings', 'Report Settings', 'fas fa-file-image'));
        }
    }
    
    if (role === USER_ROLES.COURT_USER || hasAnyRole([USER_ROLES.ADMIN, USER_ROLES.SUPER_ADMIN])) {
        if (role === USER_ROLES.COURT_USER) {
            nav.append(createNavItem('court-dashboard', 'Court Dashboard', 'fas fa-tachometer-alt'));
            nav.append(createNavItem('court-cases', 'Court Cases', 'fas fa-gavel'));
            nav.append(createNavItem('cases-by-category', 'Cases by Category', 'fas fa-folder-tree'));
        }
    }
}

// Create navigation item
function createNavItem(id, text, icon, active = false) {
    return `
        <a href="#" class="nav-item ${active ? 'active' : ''}" data-page="${id}">
            <i class="${icon}"></i>
            <span>${text}</span>
        </a>
    `;
}

// Load notifications
async function loadNotifications() {
    try {
        const response = await commonAPI.getNotifications();
        
        if (response.status === 'success') {
            const notifications = response.data;
            const unreadCount = notifications.filter(n => !n.is_read).length;
            
            // Update badge
            $('#notificationBadge').text(unreadCount);
            
            // Update notification list
            const list = $('#notificationList');
            list.empty();
            
            if (notifications.length === 0) {
                list.append('<div class="dropdown-item">No notifications</div>');
            } else {
                notifications.slice(0, 10).forEach(notification => {
                    list.append(createNotificationItem(notification));
                });
            }
        }
    } catch (error) {
        console.error('Failed to load notifications:', error);
    }
}

// Create notification item
function createNotificationItem(notification) {
    return `
        <a href="#" class="dropdown-item ${notification.is_read ? '' : 'unread'}" 
           onclick="handleNotificationClick(${notification.id}, '${notification.link_entity_type}', ${notification.link_entity_id})">
            <strong>${notification.title}</strong><br>
            <small>${notification.message}</small>
        </a>
    `;
}

// Handle notification click
async function handleNotificationClick(notificationId, entityType, entityId) {
    try {
        await commonAPI.markNotificationRead(notificationId);
        
        // Navigate to relevant page
        if (entityType === 'cases') {
            loadCaseDetails(entityId);
        }
        
        // Reload notifications
        loadNotifications();
    } catch (error) {
        console.error('Failed to mark notification as read:', error);
    }
}

// Load dashboard
async function loadDashboard() {
    $('#pageTitle').text('Dashboard');
    const content = $('#pageContent');
    content.html('<div class="loading">Loading dashboard...</div>');
    
    try {
        const response = await commonAPI.getDashboard();
        
        if (response.status === 'success') {
            const data = response.data;
            content.html(renderDashboard(data));
        }
    } catch (error) {
        console.error('Failed to load dashboard:', error);
        content.html('<div class="alert alert-error">Failed to load dashboard</div>');
    }
}

// Show alert message
function showAlert(message, type = 'success') {
    const alertHtml = `
        <div class="alert alert-${type}" style="margin-bottom: 20px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        </div>
    `;
    
    $('#pageContent').prepend(alertHtml);
    
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}

// Format date
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

// Format date only
function formatDateOnly(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

// Get status badge HTML
function getStatusBadge(status) {
    return `<span class="badge-status ${status}">${status.replace('_', ' ').toUpperCase()}</span>`;
}

// Get priority badge HTML
function getPriorityBadge(priority) {
    const colors = {
        low: '#6b7280',
        medium: '#3b82f6',
        high: '#f59e0b',
        critical: '#ef4444'
    };
    return `<span class="badge-status" style="background: ${colors[priority]}; color: white;">${priority.toUpperCase()}</span>`;
}

// Setup routing - handle browser back/forward buttons
function setupRouting() {
    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.page) {
            loadPage(event.state.page, false);
            updateActiveNavItem(event.state.page);
        } else {
            loadPageFromURL();
        }
    });
}

// Load page from current URL
function loadPageFromURL() {
    const hash = window.location.hash.substring(1); // Remove the '#'
    const page = hash || 'dashboard';
    loadPage(page, false);
    updateActiveNavItem(page);
}

// Navigate to a page and update URL
function navigateToPage(page) {
    // Update URL without reloading page
    const newURL = window.location.pathname + '#' + page;
    history.pushState({ page: page }, '', newURL);
    
    // Load the page content
    loadPage(page, true);
}

// Update active navigation item
function updateActiveNavItem(page) {
    $('.nav-item').removeClass('active');
    $(`.nav-item[data-page="${page}"]`).addClass('active');
}

// Load page based on navigation
function loadPage(page, updateNav = true) {
    console.log('Loading page:', page);
    
    if (updateNav) {
        updateActiveNavItem(page);
    }
    
    switch(page) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'users':
            loadUsersPage();
            break;
        case 'centers':
            loadCentersPage();
            break;
        case 'audit-logs':
            loadAuditLogsPage();
            break;
        case 'pending-cases':
            loadPendingCasesPage();
            break;
        case 'all-cases':
            loadAllCasesPage();
            break;
        case 'ob-entry':
            loadOBEntryPage();
            break;
        case 'my-cases':
            loadMyCasesPage();
            break;
        case 'investigations':
            loadInvestigationsPage();
            break;
        case 'report-settings':
            loadReportSettingsPage();
            break;
        case 'evidence':
            loadEvidencePage();
            break;
        case 'court-cases':
            loadCourtCasesPage();
            break;
        case 'custody':
            loadCustodyPage();
            break;
        case 'assignments':
            loadAssignmentsPage();
            break;
        case 'reports':
            loadReportsPage();
            break;
        case 'categories':
            loadCategoriesManagement();
            break;
        case 'cases-by-category':
            loadCasesByCategory();
            break;
        case 'court-dashboard':
            loadCourtDashboard();
            break;
        case 'court-cases':
            loadCourtCases();
            break;
        default:
            $('#pageContent').html('<div class="alert alert-info">Page under construction: ' + page + '</div>');
    }
}

// User Management Page
function loadUsersPage() {
    $('#pageTitle').text('User Management');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="showCreateUserModal()">
                <i class="fas fa-plus"></i> Create New User
            </button>
        </div>
        <div id="usersTable">Loading users...</div>
    `);
    
    loadUsersTable();
}

async function loadUsersTable() {
    try {
        const response = await adminAPI.getUsers();
        if (response.status === 'success') {
            const users = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.full_name}</td>
                        <td>${user.email}</td>
                        <td><span class="badge-status">${user.role}</span></td>
                        <td><span class="badge-status ${user.is_active ? 'approved' : 'draft'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editUser(${user.id})">Edit</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#usersTable').html(html);
        }
    } catch (error) {
        $('#usersTable').html('<div class="alert alert-error">Failed to load users</div>');
    }
}

// Police Centers Page
function loadCentersPage() {
    $('#pageTitle').text('Police Centers');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="showCreateCenterModal()">
                <i class="fas fa-plus"></i> Add New Center
            </button>
        </div>
        <div id="centersTable">Loading police centers...</div>
    `);
    
    loadCentersTable();
}

async function loadCentersTable() {
    console.log('Loading centers table...');
    try {
        const response = await adminAPI.getCenters();
        console.log('Centers response:', response);
        
        if (response.status === 'success') {
            const centers = response.data;
            console.log('Number of centers:', centers.length);
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            centers.forEach(center => {
                html += `
                    <tr>
                        <td><strong>${center.center_code}</strong></td>
                        <td>${center.center_name}</td>
                        <td>${center.location}</td>
                        <td>${center.phone || '-'}</td>
                        <td>${center.email || '-'}</td>
                        <td><span class="badge-status ${center.is_active ? 'approved' : 'draft'}">${center.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editCenter(${center.id})">Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="viewCenter(${center.id})">View</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#centersTable').html(html);
        }
    } catch (error) {
        $('#centersTable').html('<div class="alert alert-error">Failed to load police centers: ' + error.message + '</div>');
    }
}

function showCreateCenterModal() {
    const bodyHtml = `
        <form id="createCenterForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Center Code *</label>
                    <input type="text" name="center_code" required placeholder="e.g., KSM-004">
                </div>
                <div class="form-group">
                    <label>Center Name *</label>
                    <input type="text" name="center_name" required placeholder="e.g., Kismayo East Station">
                </div>
            </div>
            <div class="form-group">
                <label>Location *</label>
                <input type="text" name="location" required placeholder="Enter full address">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" name="phone" placeholder="+252 xxx xxx xxx">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" placeholder="center@example.com">
                </div>
            </div>
        </form>
    `;
    showModal('Create Police Center', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Create', class: 'btn btn-primary', onclick: 'submitCreateCenter()' }
    ]);
}

async function submitCreateCenter() {
    const form = $('#createCenterForm')[0];
    
    // Check form validity
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.is_active = 1;
    
    console.log('Creating center with data:', data);
    
    try {
        showLoading('Creating Center', 'Please wait...');
        const response = await adminAPI.createCenter(data);
        
        console.log('Create center response:', response);
        closeAlert();
        
        if (response.status === 'success') {
            await showSuccess('Success!', 'Police center created successfully!');
            closeModal();
            // Reload the centers table
            console.log('Reloading centers table after successful creation...');
            setTimeout(() => {
                loadCentersTable();
            }, 500);
        }
    } catch (error) {
        closeAlert();
        console.error('Create center error:', error);
        
        // Handle validation errors
        if (error.status === 400 && error.response && error.response.messages) {
            const messages = error.response.messages;
            let errorText = '';
            
            if (typeof messages === 'object') {
                errorText = Object.values(messages).join('\n');
            } else {
                errorText = messages;
            }
            
            await Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                html: errorText.replace(/\n/g, '<br>'),
                confirmButtonColor: '#ef4444'
            });
        } else {
            await showError('Error', 'Failed to create center: ' + error.message);
        }
    }
}

async function editCenter(id) {
    try {
        const response = await adminAPI.getCenter(id);
        if (response.status === 'success') {
            const center = response.data;
            
            const bodyHtml = `
                <form id="editCenterForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Center Code *</label>
                            <input type="text" name="center_code" required value="${center.center_code}">
                        </div>
                        <div class="form-group">
                            <label>Center Name *</label>
                            <input type="text" name="center_name" required value="${center.center_name}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Location *</label>
                        <input type="text" name="location" required value="${center.location}">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" name="phone" value="${center.phone || ''}">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email" value="${center.email || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="is_active" ${center.is_active ? 'checked' : ''}> Active
                        </label>
                    </div>
                </form>
            `;
            
            showModal('Edit Police Center', bodyHtml, [
                { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
                { text: 'Save Changes', class: 'btn btn-primary', onclick: `submitEditCenter(${id})` }
            ]);
        }
    } catch (error) {
        alert('Failed to load center details: ' + error.message);
    }
}

async function submitEditCenter(id) {
    const form = $('#editCenterForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.is_active = data.is_active ? 1 : 0;
    
    try {
        const response = await adminAPI.updateCenter(id, data);
        if (response.status === 'success') {
            await showSuccess('Success!', 'Center updated successfully!');
            closeModal();
            loadCentersTable();
        }
    } catch (error) {
        await showError('Error', 'Failed to update center: ' + error.message);
    }
}

async function viewCenter(id) {
    try {
        const response = await adminAPI.getCenter(id);
        if (response.status === 'success') {
            const center = response.data;
            
            const bodyHtml = `
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Center Code</span>
                        <span class="info-value">${center.center_code}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Center Name</span>
                        <span class="info-value">${center.center_name}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Location</span>
                        <span class="info-value">${center.location}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Phone</span>
                        <span class="info-value">${center.phone || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">${center.email || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value"><span class="badge-status ${center.is_active ? 'approved' : 'draft'}">${center.is_active ? 'Active' : 'Inactive'}</span></span>
                    </div>
                </div>
                
                ${center.gps_latitude ? `
                <div style="margin-top: 20px;">
                    <h3>GPS Location</h3>
                    <p>Latitude: ${center.gps_latitude}<br>Longitude: ${center.gps_longitude}</p>
                </div>` : ''}
                
                <div style="margin-top: 20px;">
                    <h3>Statistics</h3>
                    <p>Total Users: ${center.total_users || 0}<br>Active Cases: ${center.active_cases || 0}</p>
                </div>
            `;
            
            showModal('Police Center Details', bodyHtml, [
                { text: 'Edit', class: 'btn btn-primary', onclick: `closeModal(); editCenter(${id})` },
                { text: 'Close', class: 'btn btn-secondary', onclick: 'closeModal()' }
            ]);
        }
    } catch (error) {
        alert('Failed to load center details: ' + error.message);
    }
}

// Audit Logs Page
function loadAuditLogsPage() {
    $('#pageTitle').text('Audit Logs');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
            <input type="text" id="auditSearch" placeholder="Search by user or action..." style="flex: 1; padding: 8px;">
            <select id="auditActionFilter" style="padding: 8px;">
                <option value="">All Actions</option>
                <option value="CREATE">Create</option>
                <option value="UPDATE">Update</option>
                <option value="DELETE">Delete</option>
                <option value="LOGIN">Login</option>
                <option value="LOGOUT">Logout</option>
            </select>
            <button class="btn btn-primary" onclick="filterAuditLogs()">Filter</button>
            <button class="btn btn-secondary" onclick="exportAuditLogs()">Export</button>
        </div>
        <div id="auditLogsTable">Loading audit logs...</div>
    `);
    
    loadAuditLogsTable();
}

async function loadAuditLogsTable(filters = {}) {
    try {
        const response = await adminAPI.getAuditLogs(filters);
        if (response.status === 'success') {
            const logs = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Entity</th>
                            <th>Description</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (logs.length === 0) {
                html += '<tr><td colspan="6" style="text-align: center;">No audit logs found</td></tr>';
            } else {
                logs.forEach(log => {
                    const date = new Date(log.created_at);
                    html += `
                        <tr>
                            <td>${date.toLocaleString()}</td>
                            <td>${log.username}</td>
                            <td><span class="badge-status">${log.action}</span></td>
                            <td>${log.entity_type} #${log.entity_id || '-'}</td>
                            <td>${log.description}</td>
                            <td>${log.ip_address}</td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#auditLogsTable').html(html);
        }
    } catch (error) {
        $('#auditLogsTable').html('<div class="alert alert-error">Failed to load audit logs: ' + error.message + '</div>');
    }
}

function filterAuditLogs() {
    const search = $('#auditSearch').val();
    const action = $('#auditActionFilter').val();
    loadAuditLogsTable({ search, action });
}

function exportAuditLogs() {
    window.open('/admin/audit-logs/export', '_blank');
    // Or implement client-side CSV export
}

// Pending Cases Page
function loadPendingCasesPage() {
    $('#pageTitle').text('Pending Approval');
    const content = $('#pageContent');
    content.html(`
        <div id="pendingCasesTable">Loading pending cases...</div>
    `);
    
    loadPendingCasesTable();
}

async function loadPendingCasesTable() {
    try {
        const response = await stationAPI.getPendingCases();
        if (response.status === 'success') {
            const cases = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>OB Number</th>
                            <th>Crime Type</th>
                            <th>Incident Date</th>
                            <th>Priority</th>
                            <th>Submitted By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (cases.length === 0) {
                html += '<tr><td colspan="7" style="text-align: center;">No pending cases</td></tr>';
            } else {
                cases.forEach(caseItem => {
                    html += `
                        <tr>
                            <td><strong>${caseItem.case_number}</strong></td>
                            <td>${caseItem.ob_number}</td>
                            <td>${caseItem.crime_type}</td>
                            <td>${new Date(caseItem.incident_date).toLocaleDateString()}</td>
                            <td>${getPriorityBadge(caseItem.priority)}</td>
                            <td>${caseItem.created_by_name || 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="approveCase(${caseItem.id})">Approve</button>
                                <button class="btn btn-sm btn-warning" onclick="returnCase(${caseItem.id})">Return</button>
                                <button class="btn btn-sm btn-secondary" onclick="viewCaseDetails(${caseItem.id})">View</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#pendingCasesTable').html(html);
        }
    } catch (error) {
        $('#pendingCasesTable').html('<div class="alert alert-error">Failed to load pending cases: ' + error.message + '</div>');
    }
}

async function approveCase(caseId) {
    const result = await showConfirm('Approve Case?', 'Approve this case and assign investigators?', 'Yes, approve');
    if (result.isConfirmed) {
        try {
            const response = await stationAPI.approveCase(caseId);
            if (response.status === 'success') {
                await showSuccess('Success!', 'Case approved successfully!');
                loadPendingCasesTable();
            }
        } catch (error) {
            await showError('Error', 'Failed to approve case: ' + error.message);
        }
    }
}

async function returnCase(caseId) {
    const result = await showPrompt('Return Case', 'Enter reason for returning this case:', 'Reason for returning...');
    if (result.isConfirmed && result.value) {
        try {
            const response = await stationAPI.returnCase(caseId, { reason: result.value });
            if (response.status === 'success') {
                await showSuccess('Success!', 'Case returned to OB officer');
                loadPendingCasesTable();
            }
        } catch (error) {
            await showError('Error', 'Failed to return case: ' + error.message);
        }
    }
}

async function viewCaseDetails(caseId) {
    // Get user role
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    const userRole = userData.role;
    
    // Only investigators get the full-page modal
    if (userRole === 'investigator' && typeof showFullCaseDetailsModal === 'function') {
        const result = await showFullCaseDetailsModal(caseId);
        // If modal opened successfully, return
        if (result !== null) {
            return;
        }
    }
    
    // Fallback to old modal if new one not loaded
    try {
        // Get user role to determine which API to use
        const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
        const userRole = userData.role;
        
        // Use appropriate API based on role
        let response;
        if (userRole === 'investigator') {
            response = await investigationAPI.getCase(caseId);
        } else if (userRole === 'court_user') {
            // Court users use court API
            response = await courtAPI.getCase(caseId);
        } else if (userRole === 'admin' || userRole === 'super_admin') {
            // Admins can use station API which has broader access
            response = await stationAPI.getCase(caseId);
        } else {
            // OB officers and others use OB API
            response = await obAPI.getCase(caseId);
        }
        
        if (response.status === 'success') {
            const caseData = response.data;
            
            const bodyHtml = `
                <div class="case-details-modal">
                    <!-- Header Section -->
                    <div class="case-header">
                        <div class="case-header-left">
                            <h2 style="margin: 0;">${caseData.case_number}</h2>
                            <p style="margin: 5px 0 0 0;">OB Number: <strong>${caseData.ob_number}</strong></p>
                        </div>
                        <div class="case-header-right">
                            ${getStatusBadge(caseData.status)}
                            ${getPriorityBadge(caseData.priority)}
                            ${caseData.is_sensitive ? '<span class="badge-status" style="background: #ef4444; margin-left: 5px;">SENSITIVE</span>' : ''}
                        </div>
                    </div>
                    
                    <!-- Crime Information -->
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-gavel"></i> Crime Information</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Crime Type</label>
                                <p>${caseData.crime_type}</p>
                            </div>
                            <div class="detail-item">
                                <label>Category</label>
                                <p><span class="badge-status" style="text-transform: capitalize;">${caseData.crime_category}</span></p>
                            </div>
                            <div class="detail-item">
                                <label>Incident Date</label>
                                <p>${formatDate(caseData.incident_date)}</p>
                            </div>
                            <div class="detail-item">
                                <label>Report Date</label>
                                <p>${formatDate(caseData.report_date)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Incident Details -->
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-map-marker-alt"></i> Incident Details</h3>
                        <div class="detail-item">
                            <label>Location</label>
                            <p>${caseData.incident_location}</p>
                        </div>
                        <div class="detail-item">
                            <label>Description</label>
                            <p style="white-space: pre-wrap;">${caseData.incident_description}</p>
                        </div>
                    </div>
                    
                    <!-- Case Parties -->
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-users"></i> Case Parties</h3>
                        ${caseData.parties && caseData.parties.length > 0 ? `
                            <div class="parties-grid">
                                ${caseData.parties.map(party => `
                                    <div class="party-card ${party.party_role}">
                                        <div class="party-role-badge">${party.party_role.toUpperCase()}</div>
                                        <div class="party-card-content">
                                            <div class="party-photo">
                                                ${party.photo_path ? `
                                                    <img src="/${party.photo_path}" alt="${party.first_name} ${party.last_name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=party-photo-placeholder><i class=fas fa-user></i></div>'">
                                                ` : `
                                                    <div class="party-photo-placeholder">
                                                        <i class="fas fa-user"></i>
                                                    </div>
                                                `}
                                            </div>
                                            <div class="party-info">
                                                <h4>${party.first_name || ''} ${party.last_name || ''}</h4>
                                                <div class="party-details">
                                                    <div class="party-detail">
                                                        <i class="fas fa-id-card"></i>
                                                        <span>${party.national_id || 'Not provided'}</span>
                                                    </div>
                                                    <div class="party-detail">
                                                        <i class="fas fa-phone"></i>
                                                        <span>${party.phone || 'Not provided'}</span>
                                                    </div>
                                                    <div class="party-detail">
                                                        <i class="fas fa-venus-mars"></i>
                                                        <span>${party.gender ? party.gender.charAt(0).toUpperCase() + party.gender.slice(1) : 'Not specified'}</span>
                                                    </div>
                                                    ${party.address ? `
                                                    <div class="party-detail">
                                                        <i class="fas fa-home"></i>
                                                        <span>${party.address}</span>
                                                    </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="empty-state">
                                <i class="fas fa-user-slash" style="font-size: 48px; color: #d1d5db;"></i>
                                <p>No parties added yet</p>
                                <small>Add accuser and accused information to submit this case</small>
                            </div>
                        `}
                    </div>
                    
                    <!-- Investigation Assignment -->
                    ${caseData.investigating_officer_name ? `
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-user-tie"></i> Investigation Assignment</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Investigating Officer</label>
                                <p><strong>${caseData.investigating_officer_name}</strong></p>
                            </div>
                            ${caseData.sent_by_name ? `
                            <div class="detail-item">
                                <label>Sent to Court By</label>
                                <p>${caseData.sent_by_name}</p>
                            </div>
                            ` : ''}
                            ${caseData.sent_to_court_at ? `
                            <div class="detail-item">
                                <label>Sent to Court Date</label>
                                <p>${formatDateTime(caseData.sent_to_court_at)}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Related Cases -->
                    <div class="detail-section" id="relatedCasesSection">
                        <h3 class="section-title"><i class="fas fa-link"></i> Related Cases</h3>
                        <div id="relatedCasesContent">Loading...</div>
                    </div>
                    
                    ${caseData.investigators && caseData.investigators.length > 0 ? `
                    <div class="detail-section">
                        <h3 class="section-title"><i class="fas fa-user-shield"></i> Assigned Investigators</h3>
                        <div class="investigators-list">
                            ${caseData.investigators.map(inv => `
                                <div class="investigator-card">
                                    <div class="investigator-avatar">
                                        <i class="fas fa-user-tie"></i>
                                    </div>
                                    <div class="investigator-info">
                                        <h4>${inv.full_name}</h4>
                                        <p>Badge: ${inv.badge_number}</p>
                                        <span class="badge-status ${inv.is_lead_investigator ? 'approved' : 'draft'}">
                                            ${inv.is_lead_investigator ? 'Lead Investigator' : 'Investigator'}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <style>
                    .case-details-modal {
                        /* No max-height or overflow - let modal handle it */
                    }
                    
                    .case-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        padding: 25px;
                        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
                        color: white;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
                    }
                    
                    .case-header h2 {
                        color: white !important;
                    }
                    
                    .case-header p {
                        color: #e0e7ff !important;
                    }
                    
                    .case-header-right {
                        display: flex;
                        gap: 8px;
                        flex-wrap: wrap;
                    }
                    
                    .detail-section {
                        background: #f9fafb;
                        padding: 20px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                    }
                    
                    .section-title {
                        margin: 0 0 15px 0;
                        color: #374151;
                        font-size: 18px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    
                    .section-title i {
                        color: #667eea;
                    }
                    
                    .detail-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                    }
                    
                    .detail-item label {
                        display: block;
                        font-size: 12px;
                        color: #6b7280;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-bottom: 5px;
                        font-weight: 600;
                    }
                    
                    .detail-item p {
                        margin: 0;
                        color: #1f2937;
                        font-size: 15px;
                    }
                    
                    .parties-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                        gap: 20px;
                    }
                    
                    .party-card {
                        background: white;
                        padding: 20px;
                        border-radius: 12px;
                        border: 2px solid #e5e7eb;
                        position: relative;
                    }
                    
                    .party-card-content {
                        display: flex;
                        gap: 20px;
                        align-items: flex-start;
                    }
                    
                    .party-photo {
                        flex-shrink: 0;
                        width: 120px;
                        height: 150px;
                        border-radius: 8px;
                        overflow: hidden;
                        border: 2px solid #e5e7eb;
                    }
                    
                    .party-photo img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    }
                    
                    .party-photo-placeholder {
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 48px;
                        color: #9ca3af;
                    }
                    
                    .party-info {
                        flex: 1;
                    }
                    
                    .party-card.accuser {
                        border-color: #3b82f6;
                    }
                    
                    .party-card.accused {
                        border-color: #ef4444;
                    }
                    
                    .party-role-badge {
                        position: absolute;
                        top: -10px;
                        right: 15px;
                        background: #667eea;
                        color: white;
                        padding: 4px 12px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                        letter-spacing: 0.5px;
                    }
                    
                    .party-card.accuser .party-role-badge {
                        background: #3b82f6;
                    }
                    
                    .party-card.accused .party-role-badge {
                        background: #ef4444;
                    }
                    
                    .party-info h4 {
                        margin: 0 0 15px 0;
                        color: #1f2937;
                        font-size: 20px;
                        font-weight: 600;
                    }
                    
                    .party-details {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }
                    
                    .party-detail {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        color: #6b7280;
                        font-size: 14px;
                    }
                    
                    .party-detail i {
                        width: 20px;
                        color: #9ca3af;
                    }
                    
                    .investigators-list {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }
                    
                    .investigator-card {
                        background: white;
                        padding: 15px;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        border: 1px solid #e5e7eb;
                    }
                    
                    .investigator-avatar {
                        width: 50px;
                        height: 50px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 24px;
                    }
                    
                    .investigator-info h4 {
                        margin: 0;
                        color: #1f2937;
                        font-size: 16px;
                    }
                    
                    .investigator-info p {
                        margin: 5px 0;
                        color: #6b7280;
                        font-size: 13px;
                    }
                    
                    .empty-state {
                        text-align: center;
                        padding: 40px;
                        color: #6b7280;
                    }
                    
                    .empty-state p {
                        margin: 15px 0 5px 0;
                        font-size: 16px;
                        font-weight: 500;
                    }
                    
                    .empty-state small {
                        color: #9ca3af;
                    }
                </style>
            `;
            
            showModal(`Case Details`, bodyHtml, [
                { text: 'Close', class: 'btn btn-secondary', onclick: 'closeModal()' }
            ], 'large');
            
            // Load related cases after modal is shown
            loadRelatedCasesForView(caseId);
        }
    } catch (error) {
        await showError('Error', 'Failed to load case details: ' + error.message);
    }
}

// All Cases Page
function loadAllCasesPage() {
    $('#pageTitle').text('All Cases');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
            <input type="text" id="caseSearch" placeholder="Search by case number..." style="flex: 1; padding: 8px;">
            <select id="caseStatusFilter" style="padding: 8px;">
                <option value="">All Status</option>
                <option value="draft">Draft</option>
                <option value="submitted">Submitted</option>
                <option value="approved">Approved</option>
                <option value="assigned">Assigned</option>
                <option value="investigating">Investigating</option>
                <option value="solved">Solved</option>
                <option value="escalated">Escalated</option>
                <option value="court_pending">Court Pending</option>
                <option value="closed">Closed</option>
            </select>
            <select id="casePriorityFilter" style="padding: 8px;">
                <option value="">All Priority</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
            </select>
            <button class="btn btn-primary" onclick="filterAllCases()">Filter</button>
        </div>
        <div id="allCasesTable">Loading all cases...</div>
    `);
    
    loadAllCasesTable();
}

async function loadAllCasesTable(filters = {}) {
    try {
        const response = await obAPI.getCases(filters);
        if (response.status === 'success') {
            const cases = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>Crime Type</th>
                            <th>Category</th>
                            <th>Incident Date</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (cases.length === 0) {
                html += '<tr><td colspan="7" style="text-align: center;">No cases found</td></tr>';
            } else {
                cases.forEach(caseItem => {
                    html += `
                        <tr>
                            <td><strong>${caseItem.case_number}</strong></td>
                            <td>${caseItem.crime_type}</td>
                            <td><span class="badge-status">${caseItem.crime_category}</span></td>
                            <td>${new Date(caseItem.incident_date).toLocaleDateString()}</td>
                            <td>${getPriorityBadge(caseItem.priority)}</td>
                            <td>${getStatusBadge(caseItem.status)}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewCaseDetails(${caseItem.id})">View</button>
                                <button class="btn btn-sm btn-primary" onclick="showAssignInvestigatorModal(${caseItem.id}, '${caseItem.case_number}')">Assign</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#allCasesTable').html(html);
        }
    } catch (error) {
        $('#allCasesTable').html('<div class="alert alert-error">Failed to load cases: ' + error.message + '</div>');
    }
}

function filterAllCases() {
    const search = $('#caseSearch').val();
    const status = $('#caseStatusFilter').val();
    const priority = $('#casePriorityFilter').val();
    loadAllCasesTable({ search, status, priority });
}

function manageCaseAssignment(caseId) {
    alert('Manage Case Assignment #' + caseId + ' - Coming soon!');
}

// OB Entry Page
function loadOBEntryPage() {
    $('#pageTitle').text('Create OB Entry');
    const content = $('#pageContent');
    content.html(`
        <form id="obEntryForm" style="max-width: 1200px;">
            <h3>Case Information</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Crime Type *</label>
                    <input type="text" name="crime_type" required placeholder="e.g., Theft, Assault">
                </div>
                <div class="form-group">
                    <label>Crime Category *</label>
                    <select name="crime_category" required>
                        <option value="">Select Category</option>
                        <option value="violent">Violent Crime</option>
                        <option value="property">Property Crime</option>
                        <option value="drug">Drug Related</option>
                        <option value="cybercrime">Cybercrime</option>
                        <option value="sexual">Sexual Offense</option>
                        <option value="juvenile">Juvenile</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Priority *</label>
                    <select name="priority" required>
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Incident Date & Time *</label>
                    <input type="datetime-local" name="incident_date" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Incident Location *</label>
                <input type="text" name="incident_location" required placeholder="Detailed location of incident">
            </div>
            
            <div class="form-group">
                <label>Incident Description *</label>
                <textarea name="incident_description" rows="5" required placeholder="Detailed description of the incident"></textarea>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="is_sensitive"> Mark as Sensitive Case
                </label>
            </div>
            
            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e5e7eb;">
            
            <h3>Related Cases (Optional)</h3>
            <p style="color: #6b7280; margin-bottom: 15px;">Connect this case to existing cases if they are related</p>
            
            <div class="form-group">
                <label>Search for Related Cases</label>
                <input type="text" id="relatedCaseSearch" placeholder="Search by case number, crime type, or description..." onkeyup="searchRelatedCases(event)">
            </div>
            
            <div id="relatedCasesResults" style="display: none; margin-bottom: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px;">
                <!-- Search results will appear here -->
            </div>
            
            <div id="selectedRelatedCases">
                <!-- Selected related cases will appear here -->
            </div>
            
            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e5e7eb;">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Accuser Information *</h3>
                <button type="button" class="btn btn-sm btn-primary" onclick="addAccuserForm()">
                    <i class="fas fa-plus"></i> Add Another Accuser
                </button>
            </div>
            
            <div id="accusersContainer">
                <div class="party-form-section" data-party-index="0">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" name="accuser_name_0" required placeholder="Full name of accuser">
                        </div>
                        <div class="form-group">
                            <label>National ID</label>
                            <input type="text" name="accuser_id_0" placeholder="National ID number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" name="accuser_phone_0" placeholder="Phone number">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select name="accuser_gender_0">
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" name="accuser_address_0" placeholder="Physical address">
                    </div>
                </div>
            </div>
            
            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e5e7eb;">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Accused Information *</h3>
                <button type="button" class="btn btn-sm btn-primary" onclick="addAccusedForm()">
                    <i class="fas fa-plus"></i> Add Another Accused
                </button>
            </div>
            
            <div id="accusedContainer">
                <div class="party-form-section" data-party-index="0">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" name="accused_name_0" required placeholder="Full name of accused">
                        </div>
                        <div class="form-group">
                            <label>National ID</label>
                            <input type="text" name="accused_id_0" placeholder="National ID number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" name="accused_phone_0" placeholder="Phone number">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select name="accused_gender_0">
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" name="accused_address_0" placeholder="Physical address">
                    </div>
                    
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #e5e7eb;">
                    
                    <h4 style="margin-bottom: 15px; color: #374151; font-size: 16px;">Custody/Detention Status</h4>
                    
                    <div class="form-group">
                        <label>Current Status *</label>
                        <select name="accused_status_0" required onchange="handleAccusedStatusChange(0)">
                            <option value="">-- Select Status --</option>
                            <option value="at_large">At Large (Not Arrested)</option>
                            <option value="in_custody">In Custody (Arrested)</option>
                            <option value="released_on_bail">Released on Bail</option>
                        </select>
                    </div>
                    
                    <div id="custody_details_0" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Custody Location</label>
                                <input type="text" name="accused_custody_location_0" placeholder="Police station or detention center">
                            </div>
                            <div class="form-group">
                                <label>Arrest Date & Time</label>
                                <input type="datetime-local" name="accused_arrest_date_0">
                            </div>
                        </div>
                    </div>
                    
                    <div id="bail_details_0" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Bailed By (Full Name) *</label>
                                <input type="text" name="accused_bailed_by_name_0" placeholder="Name of person who provided bail">
                            </div>
                            <div class="form-group">
                                <label>Bail Provider's National ID</label>
                                <input type="text" name="accused_bailed_by_id_0" placeholder="National ID of bail provider">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Bail Provider's Phone</label>
                                <input type="tel" name="accused_bailed_by_phone_0" placeholder="Contact number">
                            </div>
                            <div class="form-group">
                                <label>Bail Amount</label>
                                <input type="number" name="accused_bail_amount_0" placeholder="Bail amount in currency">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Bail Provider's Address</label>
                            <input type="text" name="accused_bailed_by_address_0" placeholder="Physical address of bail provider">
                        </div>
                        <div class="form-group">
                            <label>Relationship to Accused</label>
                            <select name="accused_bail_relationship_0">
                                <option value="">Select</option>
                                <option value="family">Family Member</option>
                                <option value="friend">Friend</option>
                                <option value="lawyer">Lawyer</option>
                                <option value="employer">Employer</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Release Date & Time</label>
                            <input type="datetime-local" name="accused_release_date_0">
                        </div>
                    </div>
                    
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #e5e7eb;">
                    
                    <div class="form-group">
                        <label>Photo (Optional)</label>
                        <input type="file" name="accused_photo_0" accept="image/*" onchange="previewPhoto(event, 'accused', 0)">
                        <small style="color: #6b7280; display: block; margin-top: 5px;">Upload a photo of the accused (JPG, PNG, max 5MB)</small>
                        <div id="accused_photo_preview_0" style="margin-top: 10px; display: none;">
                            <img src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #e5e7eb;">
                        </div>
                    </div>
                </div>
            </div>
            
            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e5e7eb;">
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary">Save as Draft</button>
                <button type="button" class="btn btn-success" onclick="submitOBEntry()">Submit for Approval</button>
                <button type="button" class="btn btn-secondary" onclick="navigateToPage('my-cases')">Cancel</button>
            </div>
        </form>
    `);
    
    $('#obEntryForm').on('submit', function(e) {
        e.preventDefault();
        saveOBEntry('draft');
    });
}

// Counters for dynamic forms
let accuserCounter = 1;
let accusedCounter = 1;

// Add another accuser form
function addAccuserForm() {
    const index = accuserCounter++;
    const formHtml = `
        <div class="party-form-section" data-party-index="${index}" style="margin-top: 20px; padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px; position: relative;">
            <button type="button" class="btn btn-sm btn-danger" onclick="removePartyForm(this)" style="position: absolute; top: 10px; right: 10px;">
                <i class="fas fa-times"></i> Remove
            </button>
            <h4 style="color: #3b82f6; margin-bottom: 15px;">Accuser #${index + 1}</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="accuser_name_${index}" required placeholder="Full name of accuser">
                </div>
                <div class="form-group">
                    <label>National ID</label>
                    <input type="text" name="accuser_id_${index}" placeholder="National ID number">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" name="accuser_phone_${index}" placeholder="Phone number">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select name="accuser_gender_${index}">
                        <option value="">Select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" name="accuser_address_${index}" placeholder="Physical address">
            </div>
        </div>
    `;
    $('#accusersContainer').append(formHtml);
}

// Add another accused form
function addAccusedForm() {
    const index = accusedCounter++;
    const formHtml = `
        <div class="party-form-section" data-party-index="${index}" style="margin-top: 20px; padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px; position: relative;">
            <button type="button" class="btn btn-sm btn-danger" onclick="removePartyForm(this)" style="position: absolute; top: 10px; right: 10px;">
                <i class="fas fa-times"></i> Remove
            </button>
            <h4 style="color: #ef4444; margin-bottom: 15px;">Accused #${index + 1}</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="accused_name_${index}" required placeholder="Full name of accused">
                </div>
                <div class="form-group">
                    <label>National ID</label>
                    <input type="text" name="accused_id_${index}" placeholder="National ID number">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" name="accused_phone_${index}" placeholder="Phone number">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select name="accused_gender_${index}">
                        <option value="">Select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" name="accused_address_${index}" placeholder="Physical address">
            </div>
            
            <hr style="margin: 15px 0; border: none; border-top: 1px solid #e5e7eb;">
            
            <h4 style="margin-bottom: 15px; color: #374151; font-size: 16px;">Custody/Detention Status</h4>
            
            <div class="form-group">
                <label>Current Status *</label>
                <select name="accused_status_${index}" required onchange="handleAccusedStatusChange(${index})">
                    <option value="">-- Select Status --</option>
                    <option value="at_large">At Large (Not Arrested)</option>
                    <option value="in_custody">In Custody (Arrested)</option>
                    <option value="released_on_bail">Released on Bail</option>
                </select>
            </div>
            
            <div id="custody_details_${index}" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Custody Location</label>
                        <input type="text" name="accused_custody_location_${index}" placeholder="Police station or detention center">
                    </div>
                    <div class="form-group">
                        <label>Arrest Date & Time</label>
                        <input type="datetime-local" name="accused_arrest_date_${index}">
                    </div>
                </div>
            </div>
            
            <div id="bail_details_${index}" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Bailed By (Full Name) *</label>
                        <input type="text" name="accused_bailed_by_name_${index}" placeholder="Name of person who provided bail">
                    </div>
                    <div class="form-group">
                        <label>Bail Provider's National ID</label>
                        <input type="text" name="accused_bailed_by_id_${index}" placeholder="National ID of bail provider">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Bail Provider's Phone</label>
                        <input type="tel" name="accused_bailed_by_phone_${index}" placeholder="Contact number">
                    </div>
                    <div class="form-group">
                        <label>Bail Amount</label>
                        <input type="number" name="accused_bail_amount_${index}" placeholder="Bail amount in currency">
                    </div>
                </div>
                <div class="form-group">
                    <label>Bail Provider's Address</label>
                    <input type="text" name="accused_bailed_by_address_${index}" placeholder="Physical address of bail provider">
                </div>
                <div class="form-group">
                    <label>Relationship to Accused</label>
                    <select name="accused_bail_relationship_${index}">
                        <option value="">Select</option>
                        <option value="family">Family Member</option>
                        <option value="friend">Friend</option>
                        <option value="lawyer">Lawyer</option>
                        <option value="employer">Employer</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Release Date & Time</label>
                    <input type="datetime-local" name="accused_release_date_${index}">
                </div>
            </div>
            
            <hr style="margin: 15px 0; border: none; border-top: 1px solid #e5e7eb;">
            
            <div class="form-group">
                <label>Photo (Optional)</label>
                <input type="file" name="accused_photo_${index}" accept="image/*" onchange="previewPhoto(event, 'accused', ${index})">
                <small style="color: #6b7280; display: block; margin-top: 5px;">Upload a photo of the accused (JPG, PNG, max 5MB)</small>
                <div id="accused_photo_preview_${index}" style="margin-top: 10px; display: none;">
                    <img src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #e5e7eb;">
                </div>
            </div>
        </div>
    `;
    $('#accusedContainer').append(formHtml);
}

// Handle accused status change to show/hide relevant fields
function handleAccusedStatusChange(index) {
    const status = $(`select[name="accused_status_${index}"]`).val();
    const custodyDetails = $(`#custody_details_${index}`);
    const bailDetails = $(`#bail_details_${index}`);
    
    // Hide both sections first
    custodyDetails.hide();
    bailDetails.hide();
    
    // Clear required attributes
    $(`input[name="accused_bailed_by_name_${index}"]`).prop('required', false);
    
    if (status === 'in_custody') {
        // Show custody details
        custodyDetails.show();
    } else if (status === 'released_on_bail') {
        // Show both custody (for arrest info) and bail details
        custodyDetails.show();
        bailDetails.show();
        // Make bail provider name required
        $(`input[name="accused_bailed_by_name_${index}"]`).prop('required', true);
    }
    // If 'at_large', both remain hidden
}

// Remove party form
function removePartyForm(button) {
    $(button).closest('.party-form-section').remove();
}

// Preview photo (unified for all parties)
function previewPhoto(event, partyType, index) {
    const file = event.target.files[0];
    if (file) {
        // Check file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            showError('File Too Large', 'Please select an image smaller than 5MB');
            event.target.value = '';
            return;
        }
        
        // Check file type
        if (!file.type.startsWith('image/')) {
            showError('Invalid File Type', 'Please select a valid image file');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            $(`#${partyType}_photo_preview_${index} img`).attr('src', e.target.result);
            $(`#${partyType}_photo_preview_${index}`).show();
        };
        reader.readAsDataURL(file);
    } else {
        $(`#${partyType}_photo_preview_${index}`).hide();
    }
}

async function saveOBEntry(status) {
    const form = $('#obEntryForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Helper function to split name into first and last name
    function splitName(fullName) {
        const parts = fullName.trim().split(' ');
        if (parts.length === 1) {
            return { first_name: parts[0], last_name: parts[0] };
        }
        const firstName = parts[0];
        const lastName = parts.slice(1).join(' ');
        return { first_name: firstName, last_name: lastName };
    }
    
    // Extract all accusers
    const accusers = [];
    let accuserIndex = 0;
    while (data[`accuser_name_${accuserIndex}`]) {
        const accuserName = splitName(data[`accuser_name_${accuserIndex}`]);
        accusers.push({
            person_type: 'accuser',
            first_name: accuserName.first_name,
            last_name: accuserName.last_name,
            national_id: data[`accuser_id_${accuserIndex}`] || null,
            phone: data[`accuser_phone_${accuserIndex}`] || null,
            gender: data[`accuser_gender_${accuserIndex}`] || null,
            address: data[`accuser_address_${accuserIndex}`] || null
        });
        
        // Delete from case data
        delete data[`accuser_name_${accuserIndex}`];
        delete data[`accuser_id_${accuserIndex}`];
        delete data[`accuser_phone_${accuserIndex}`];
        delete data[`accuser_gender_${accuserIndex}`];
        delete data[`accuser_address_${accuserIndex}`];
        
        accuserIndex++;
    }
    
    // Extract all accused with photos
    const accused = [];
    let accusedIndex = 0;
    while (data[`accused_name_${accusedIndex}`]) {
        const accusedName = splitName(data[`accused_name_${accusedIndex}`]);
        const photoFile = formData.get(`accused_photo_${accusedIndex}`);
        
        accused.push({
            data: {
                person_type: 'accused',
                first_name: accusedName.first_name,
                last_name: accusedName.last_name,
                national_id: data[`accused_id_${accusedIndex}`] || null,
                phone: data[`accused_phone_${accusedIndex}`] || null,
                gender: data[`accused_gender_${accusedIndex}`] || null,
                address: data[`accused_address_${accusedIndex}`] || null
            },
            photo: photoFile && photoFile.size > 0 ? photoFile : null
        });
        
        // Delete from case data
        delete data[`accused_name_${accusedIndex}`];
        delete data[`accused_id_${accusedIndex}`];
        delete data[`accused_phone_${accusedIndex}`];
        delete data[`accused_gender_${accusedIndex}`];
        delete data[`accused_address_${accusedIndex}`];
        delete data[`accused_photo_${accusedIndex}`];
        
        accusedIndex++;
    }
    
    data.status = status;
    data.is_sensitive = data.is_sensitive ? 1 : 0;
    
    console.log('Submitting case data:', data);
    console.log('Accusers:', accusers);
    console.log('Accused:', accused);
    
    try {
        showLoading('Creating Case', 'Please wait...');
        
        // Step 1: Create the case
        const caseResponse = await obAPI.createCase(data);
        if (caseResponse.status === 'success') {
            const caseId = caseResponse.data.id;
            
            // Step 2: Create all accuser person records
            for (const accuserData of accusers) {
                accuserData.case_id = caseId;
                await obAPI.createPerson(accuserData);
            }
            
            // Step 3: Create all accused person records with photos
            for (const accusedItem of accused) {
                accusedItem.data.case_id = caseId;
                
                // If there's a photo, send as FormData
                if (accusedItem.photo) {
                    const accusedFormData = new FormData();
                    Object.keys(accusedItem.data).forEach(key => {
                        if (accusedItem.data[key] !== null) {
                            accusedFormData.append(key, accusedItem.data[key]);
                        }
                    });
                    accusedFormData.append('photo', accusedItem.photo);
                    
                    // Send as multipart/form-data
                    await api.upload(API_ENDPOINTS.PERSONS, accusedFormData);
                } else {
                    // Send as JSON
                    await obAPI.createPerson(accusedItem.data);
                }
            }
            
            // Step 5: Save case relationships if any
            if (selectedRelatedCases.length > 0) {
                for (const relatedCaseId of selectedRelatedCases) {
                    try {
                        await obAPI.addCaseRelationship(caseId, {
                            related_case_id: relatedCaseId,
                            relationship_type: 'related'
                        });
                    } catch (error) {
                        console.error('Failed to link case:', error);
                    }
                }
            }
            
            closeAlert();
            await Swal.fire({
                icon: 'success',
                title: 'Success!',
                html: status === 'draft' ? 'Case saved as draft with parties' : 'Case submitted for approval' + 
                      (selectedRelatedCases.length > 0 ? `<br><small>${selectedRelatedCases.length} related case(s) linked</small>` : ''),
                confirmButtonColor: '#10b981'
            });
            
            // Clear selected related cases
            selectedRelatedCases = [];
            
            navigateToPage('my-cases');
        }
    } catch (error) {
        closeAlert();
        console.error('Case creation error:', error);
        
        // Handle validation errors
        if (error.status === 400 && error.response && error.response.messages) {
            const messages = error.response.messages;
            let errorText = '';
            
            // Format validation errors
            if (typeof messages === 'object') {
                errorText = Object.values(messages).join('\n');
            } else {
                errorText = messages;
            }
            
            await Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                html: errorText.replace(/\n/g, '<br>'),
                confirmButtonColor: '#ef4444'
            });
        } else {
            await Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to save case',
                confirmButtonColor: '#ef4444'
            });
        }
    }
}

async function submitOBEntry() {
    const result = await showConfirm('Submit Case?', 'Submit this case for approval?', 'Yes, submit');
    if (result.isConfirmed) {
        saveOBEntry('submitted');
    }
}

// My Cases Page
function loadMyCasesPage() {
    $('#pageTitle').text('My Cases');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="loadOBEntryPage()">
                <i class="fas fa-plus"></i> Create New Case
            </button>
        </div>
        <div id="myCasesTable">Loading your cases...</div>
    `);
    
    loadMyCasesTable();
}

async function loadMyCasesTable() {
    try {
        const response = await obAPI.getCases();
        if (response.status === 'success') {
            const cases = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>OB Number</th>
                            <th>Crime Type</th>
                            <th>Incident Date</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (cases.length === 0) {
                html += '<tr><td colspan="7" style="text-align: center;">No cases found. Click "Create New Case" to get started.</td></tr>';
            } else {
                cases.forEach(caseItem => {
                    html += `
                        <tr>
                            <td><strong>${caseItem.case_number}</strong></td>
                            <td>${caseItem.ob_number}</td>
                            <td>${caseItem.crime_type}</td>
                            <td>${new Date(caseItem.incident_date).toLocaleDateString()}</td>
                            <td>${getPriorityBadge(caseItem.priority)}</td>
                            <td>${getStatusBadge(caseItem.status)}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewCaseDetails(${caseItem.id})">View</button>
                                ${(caseItem.status === 'draft' || caseItem.status === 'returned') ? '<button class="btn btn-sm btn-primary" onclick="editCase(' + caseItem.id + ')">Edit</button>' : ''}
                                ${(caseItem.status === 'draft' || caseItem.status === 'returned') ? '<button class="btn btn-sm btn-success" onclick="submitCase(' + caseItem.id + ')">Submit</button>' : ''}
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#myCasesTable').html(html);
        }
    } catch (error) {
        $('#myCasesTable').html('<div class="alert alert-error">Failed to load your cases: ' + error.message + '</div>');
    }
}

async function editCase(caseId) {
    try {
        const response = await obAPI.getCase(caseId);
        if (response.status === 'success') {
            const caseData = response.data;
            
            const bodyHtml = `
                <form id="editCaseForm" style="max-height: 70vh; overflow-y: auto;">
                    <h3>Case Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Crime Type *</label>
                            <input type="text" name="crime_type" value="${caseData.crime_type}" required>
                        </div>
                        <div class="form-group">
                            <label>Crime Category *</label>
                            <select name="crime_category" required>
                                <option value="violent" ${caseData.crime_category === 'violent' ? 'selected' : ''}>Violent Crime</option>
                                <option value="property" ${caseData.crime_category === 'property' ? 'selected' : ''}>Property Crime</option>
                                <option value="drug" ${caseData.crime_category === 'drug' ? 'selected' : ''}>Drug Related</option>
                                <option value="cybercrime" ${caseData.crime_category === 'cybercrime' ? 'selected' : ''}>Cybercrime</option>
                                <option value="sexual" ${caseData.crime_category === 'sexual' ? 'selected' : ''}>Sexual Offense</option>
                                <option value="juvenile" ${caseData.crime_category === 'juvenile' ? 'selected' : ''}>Juvenile</option>
                                <option value="other" ${caseData.crime_category === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Priority *</label>
                            <select name="priority" required>
                                <option value="low" ${caseData.priority === 'low' ? 'selected' : ''}>Low</option>
                                <option value="medium" ${caseData.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                <option value="high" ${caseData.priority === 'high' ? 'selected' : ''}>High</option>
                                <option value="critical" ${caseData.priority === 'critical' ? 'selected' : ''}>Critical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Incident Date & Time *</label>
                            <input type="datetime-local" name="incident_date" value="${caseData.incident_date ? caseData.incident_date.substring(0, 16) : ''}" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Incident Location *</label>
                        <input type="text" name="incident_location" value="${caseData.incident_location}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Incident Description *</label>
                        <textarea name="incident_description" rows="5" required>${caseData.incident_description}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="is_sensitive" ${caseData.is_sensitive ? 'checked' : ''}> Mark as Sensitive Case
                        </label>
                    </div>
                    
                    <hr style="margin: 20px 0; border: none; border-top: 2px solid #e5e7eb;">
                    
                    <h3>Case Parties</h3>
                    ${caseData.parties && caseData.parties.length > 0 ? `
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${caseData.parties.map((party, index) => `
                                <div style="padding: 15px; border: 2px solid ${party.party_role === 'accuser' ? '#3b82f6' : '#ef4444'}; border-radius: 8px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong style="color: ${party.party_role === 'accuser' ? '#3b82f6' : '#ef4444'};">${party.party_role.toUpperCase()}</strong>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="removePartyFromCase(${party.id}, ${caseId})">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </div>
                                    <p><strong>Name:</strong> ${party.first_name} ${party.last_name}</p>
                                    <p><strong>ID:</strong> ${party.national_id || 'N/A'} | <strong>Phone:</strong> ${party.phone || 'N/A'}</p>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" style="margin-top: 10px;" onclick="addMoreParties(${caseId})">
                            <i class="fas fa-plus"></i> Add More Parties
                        </button>
                    ` : '<p class="alert alert-info">No parties added yet.</p>'}
                </form>
            `;
            
            showModal('Edit Case', bodyHtml, [
                { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
                { text: 'Save Changes', class: 'btn btn-primary', onclick: `submitEditCase(${caseId})` }
            ], 'large');
        }
    } catch (error) {
        await showError('Error', 'Failed to load case details: ' + error.message);
    }
}

async function removePartyFromCase(partyId, caseId) {
    const result = await showConfirm('Remove Party?', 'Are you sure you want to remove this party from the case?', 'Yes, remove');
    if (result.isConfirmed) {
        try {
            // Call API to remove party
            // For now, just reload the edit form
            await showSuccess('Success', 'Party removed successfully');
            closeModal();
            editCase(caseId);
        } catch (error) {
            await showError('Error', 'Failed to remove party: ' + error.message);
        }
    }
}

function addMoreParties(caseId) {
    closeModal();
    showAddPartiesModal(caseId);
}

async function submitEditCase(caseId) {
    const form = $('#editCaseForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.is_sensitive = data.is_sensitive ? 1 : 0;
    
    try {
        showLoading('Updating Case', 'Please wait...');
        const response = await obAPI.updateCase(caseId, data);
        
        closeAlert();
        if (response.status === 'success') {
            await showSuccess('Success!', 'Case updated successfully!');
            closeModal();
            loadMyCasesTable();
        }
    } catch (error) {
        closeAlert();
        console.error('Case update error:', error);
        
        // Handle validation errors
        if (error.status === 400 && error.response && error.response.messages) {
            const messages = error.response.messages;
            let errorText = '';
            
            // Format validation errors
            if (typeof messages === 'object') {
                errorText = Object.values(messages).join('\n');
            } else {
                errorText = messages;
            }
            
            await Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                html: errorText.replace(/\n/g, '<br>'),
                confirmButtonColor: '#ef4444'
            });
        } else {
            await showError('Error', 'Failed to update case: ' + error.message);
        }
    }
}

// OLD editCase function that was incomplete:
async function editCaseOld(caseId) {
    try {
        const response = await obAPI.getCase(caseId);
        if (response.status === 'success') {
            const caseData = response.data;
            
            // Redirect to OB Entry page with pre-filled data
            // For now, show a simplified edit modal
            const bodyHtml = `
                <form id="editCaseFormOld">
                    <div class="form-group">
                        <label>Crime Type</label>
                        <input type="text" name="crime_type" value="${caseData.crime_type}" required>
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select name="priority" required>
                            <option value="low" ${caseData.priority === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${caseData.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${caseData.priority === 'high' ? 'selected' : ''}>High</option>
                            <option value="critical" ${caseData.priority === 'critical' ? 'selected' : ''}>Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Incident Location</label>
                        <input type="text" name="incident_location" value="${caseData.incident_location}" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="incident_description" rows="5" required>${caseData.incident_description}</textarea>
                    </div>
                </form>
            `;
            
            showModal('Edit Case', bodyHtml, [
                { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
                { text: 'Save Changes', class: 'btn btn-primary', onclick: `submitEditCase(${caseId})` }
            ]);
        }
    } catch (error) {
        alert('Failed to load case for editing: ' + error.message);
    }
}

async function submitEditCase(caseId) {
    const form = $('#editCaseForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await obAPI.updateCase(caseId, data);
        if (response.status === 'success') {
            await showSuccess('Success!', 'Case updated successfully!');
            closeModal();
            loadMyCasesTable();
        }
    } catch (error) {
        await showError('Error', 'Failed to update case: ' + error.message);
    }
}

function showAddPartiesModal(caseId) {
    const bodyHtml = `
        <form id="addPartiesForm">
            <h3>Add Accuser</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="accuser_name" required placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>National ID</label>
                    <input type="text" name="accuser_id" placeholder="National ID number">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" name="accuser_phone" placeholder="Phone number">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select name="accuser_gender">
                        <option value="">Select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" name="accuser_address" placeholder="Physical address">
            </div>
            
            <h3 style="margin-top: 30px;">Add Accused</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="accused_name" required placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>National ID</label>
                    <input type="text" name="accused_id" placeholder="National ID number">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" name="accused_phone" placeholder="Phone number">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select name="accused_gender">
                        <option value="">Select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" name="accused_address" placeholder="Physical address">
            </div>
        </form>
    `;
    
    showModal('Add Case Parties', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Save Parties', class: 'btn btn-primary', onclick: `submitAddParties(${caseId})` }
    ]);
}

async function submitAddParties(caseId) {
    const form = $('#addPartiesForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        showLoading('Adding Parties', 'Please wait...');
        
        // Create accuser person record
        const accuserData = {
            full_name: data.accuser_name,
            national_id: data.accuser_id,
            phone: data.accuser_phone,
            gender: data.accuser_gender,
            address: data.accuser_address
        };
        
        const accuserResponse = await obAPI.createPerson(accuserData);
        const accuserId = accuserResponse.data.id;
        
        // Create accused person record
        const accusedData = {
            full_name: data.accused_name,
            national_id: data.accused_id,
            phone: data.accused_phone,
            gender: data.accused_gender,
            address: data.accused_address
        };
        
        const accusedResponse = await obAPI.createPerson(accusedData);
        const accusedId = accusedResponse.data.id;
        
        // Add both as case parties
        await obAPI.addCaseParty(caseId, {
            person_id: accuserId,
            party_role: 'accuser',
            is_primary: 1
        });
        
        await obAPI.addCaseParty(caseId, {
            person_id: accusedId,
            party_role: 'accused',
            is_primary: 1
        });
        
        closeAlert();
        await showSuccess('Success!', 'Parties added successfully! You can now submit the case.');
        closeModal();
        loadMyCasesTable();
    } catch (error) {
        closeAlert();
        await showError('Error', 'Failed to add parties: ' + error.message);
    }
}

async function submitCase(caseId) {
    const result = await showConfirm('Submit Case?', 'Submit this case for approval?', 'Yes, submit');
    if (result.isConfirmed) {
        try {
            const response = await obAPI.submitCase(caseId);
            if (response.status === 'success') {
                await showSuccess('Success!', 'Case submitted successfully!');
                loadMyCasesTable();
            }
        } catch (error) {
            console.error('Submit case error:', error);
            
            // Handle validation errors
            if (error.status === 400 && error.response && error.response.messages) {
                const messages = error.response.messages;
                let errorText = '';
                
                // Format validation errors
                if (typeof messages === 'object' && messages.error) {
                    errorText = messages.error;
                } else if (typeof messages === 'object') {
                    errorText = Object.values(messages).join('\n');
                } else {
                    errorText = messages;
                }
                
                await Swal.fire({
                    icon: 'warning',
                    title: 'Cannot Submit Case',
                    html: errorText + '<br><br>Please add accuser and/or accused information first.',
                    confirmButtonColor: '#f59e0b',
                    confirmButtonText: 'Add Parties'
                }).then((result) => {
                    if (result.isConfirmed) {
                        showAddPartiesModal(caseId);
                    }
                });
            } else {
                await showError('Error', 'Failed to submit case: ' + error.message);
            }
        }
    }
}

// Investigations Page
/**
 * Load Report Settings Page
 */
function loadReportSettingsPage() {
    $('#pageTitle').text('Report Settings');
    
    const content = `
        <div class="page-header">
            <h2>Report Header Settings</h2>
            <p>Customize the header image and information that appears on generated reports</p>
        </div>
        
        <div class="settings-container" style="max-width: 900px; margin: 0 auto;">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-image"></i> Report Header Image</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px; align-items: start;">
                        <div>
                            <div id="headerImagePreview" style="width: 100%; aspect-ratio: 2.5/1; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #f9f9f9; overflow: hidden;">
                                <div style="text-align: center; color: #999;">
                                    <i class="fas fa-image" style="font-size: 48px; margin-bottom: 10px;"></i>
                                    <p>No header image uploaded</p>
                                    <small>Upload a full-width banner to see preview</small>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px;">Upload Report Header Image</h4>
                            <p style="color: #666; margin-bottom: 15px;">This image will appear as the full-width header on all generated reports. Include your logo, agency name, and all necessary information in the image. Recommended size: 2100x400px (full width banner).</p>
                            
                            <div class="form-group">
                                <label>Choose Header Image:</label>
                                <input type="file" id="headerImageInput" accept="image/*" class="form-control">
                                <small class="form-text text-muted">Supported formats: JPG, PNG (Max 2MB). Create a banner image with your logo, agency name, and contact information.</small>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="uploadHeaderImage()">
                                    <i class="fas fa-upload"></i> Upload Header Image
                                </button>
                                <button class="btn btn-danger" onclick="removeHeaderImage()" id="removeHeaderBtn" style="display: none;">
                                    <i class="fas fa-trash"></i> Remove Header Image
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <div class="card-header">
                    <h3><i class="fas fa-file-alt"></i> Report Text Sections</h3>
                </div>
                <div class="card-body">
                    <form id="reportTextForm">
                        <div class="form-group">
                            <label>Statement 1 (After case numbers) *</label>
                            <textarea class="form-control" id="statement1" rows="3" required placeholder="Enter the first statement that appears after case/OB numbers"></textarea>
                            <small class="form-text text-muted">This appears right after the case and OB numbers</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Statement 2 (Below Statement 1) *</label>
                            <textarea class="form-control" id="statement2" rows="3" required placeholder="Enter the second statement"></textarea>
                            <small class="form-text text-muted">This appears below Statement 1</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Statement 3 (Before report sections) *</label>
                            <textarea class="form-control" id="statement3" rows="3" required placeholder="Enter the statement that appears before the report content"></textarea>
                            <small class="form-text text-muted">This appears after statements 1 & 2, before the main report content</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Footer Text (Signature Section) *</label>
                            <textarea class="form-control" id="footerText" rows="6" required placeholder="Enter the footer text with signature lines"></textarea>
                            <small class="form-text text-muted">This appears on the left side of the footer. Include signature lines for officers. A QR code will automatically appear on the right.</small>
                        </div>
                        
                        <div class="alert alert-info" style="margin-top: 10px;">
                            <strong><i class="fas fa-info-circle"></i> Example Footer Text:</strong>
                            <pre style="background: white; padding: 10px; margin-top: 10px; border-radius: 4px;">Prepared By:
Name: _______________________________
Signature: __________________________
Date: _______________

Reviewed By:
Name: _______________________________
Signature: __________________________
Date: _______________</pre>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Save Report Text
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <div class="card-header">
                    <h3><i class="fas fa-info-circle"></i> Instructions</h3>
                </div>
                <div class="card-body">
                    <h4>How to Create Your Header Image:</h4>
                    <ol style="line-height: 2;">
                        <li>Create a banner image in your preferred design software (Photoshop, Canva, etc.)</li>
                        <li><strong>Recommended size:</strong> 2100 x 400 pixels (full width banner)</li>
                        <li>Include in your header image:
                            <ul>
                                <li>Your agency logo/badge</li>
                                <li>Agency name in both Somali and English</li>
                                <li>Department name</li>
                                <li>Location/address</li>
                                <li>Contact information (phone, email)</li>
                            </ul>
                        </li>
                        <li>Save as JPG or PNG format</li>
                        <li>Upload using the button above</li>
                    </ol>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-left: 4px solid #0288d1; border-radius: 4px;">
                        <p style="margin: 0;"><strong><i class="fas fa-lightbulb"></i> Tip:</strong> The header image will appear at the top of every generated report. Make sure it looks professional and includes all necessary information.</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('#pageContent').html(content);
    loadCurrentSettings();
    
    // Handle file input change
    $('#headerImageInput').on('change', function() {
        previewSelectedImage(this);
    });
    
    // Handle form submission
    $('#reportTextForm').on('submit', function(e) {
        e.preventDefault();
        saveReportText();
    });
}

/**
 * Load current settings from localStorage
 */
function loadCurrentSettings() {
    const settings = JSON.parse(localStorage.getItem('reportSettings') || '{}');
    
    if (settings.headerImage) {
        $('#headerImagePreview').html(`<img src="${settings.headerImage}" style="width: 100%; height: 100%; object-fit: contain;" />`);
        $('#removeHeaderBtn').show();
    }
    
    if (settings.statement1) $('#statement1').val(settings.statement1);
    if (settings.statement2) $('#statement2').val(settings.statement2);
    if (settings.statement3) $('#statement3').val(settings.statement3);
    if (settings.footerText) $('#footerText').val(settings.footerText);
}

/**
 * Preview selected image
 */
function previewSelectedImage(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Check file size (2MB max)
        if (file.size > 2 * 1024 * 1024) {
            showError('Error', 'File size must be less than 2MB');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#headerImagePreview').html(`<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain;" />`);
        };
        reader.readAsDataURL(file);
    }
}

/**
 * Upload header image
 */
async function uploadHeaderImage() {
    const fileInput = document.getElementById('headerImageInput');
    if (!fileInput.files || !fileInput.files[0]) {
        await showError('Error', 'Please select an image file first');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        const settings = JSON.parse(localStorage.getItem('reportSettings') || '{}');
        settings.headerImage = e.target.result;
        localStorage.setItem('reportSettings', JSON.stringify(settings));
        
        $('#removeHeaderBtn').show();
        await showSuccess('Success', 'Header image uploaded successfully!');
    };
    
    reader.readAsDataURL(file);
}

/**
 * Remove header image
 */
async function removeHeaderImage() {
    const result = await showConfirm('Remove Header Image?', 'Are you sure you want to remove the header image?', 'Yes, remove');
    if (result.isConfirmed) {
        const settings = JSON.parse(localStorage.getItem('reportSettings') || '{}');
        delete settings.headerImage;
        localStorage.setItem('reportSettings', JSON.stringify(settings));
        
        $('#headerImagePreview').html(`
            <div style="text-align: center; color: #999;">
                <i class="fas fa-image" style="font-size: 48px; margin-bottom: 10px;"></i>
                <p>No header image uploaded</p>
                <small>Upload a full-width banner to see preview</small>
            </div>
        `);
        $('#removeHeaderBtn').hide();
        $('#headerImageInput').val('');
        
        await showSuccess('Success', 'Header image removed successfully!');
    }
}

/**
 * Save report text sections
 */
async function saveReportText() {
    const settings = JSON.parse(localStorage.getItem('reportSettings') || '{}');
    
    settings.statement1 = $('#statement1').val();
    settings.statement2 = $('#statement2').val();
    settings.statement3 = $('#statement3').val();
    settings.footerText = $('#footerText').val();
    
    localStorage.setItem('reportSettings', JSON.stringify(settings));
    
    await showSuccess('Success', 'Report text sections saved successfully!');
}

function loadInvestigationsPage() {
    $('#pageTitle').text('My Investigations');
    const content = $('#pageContent');
    content.html(`
        <div id="investigationsTable">Loading assigned investigations...</div>
    `);
    
    loadInvestigationsTable();
}

async function loadInvestigationsTable() {
    try {
        const response = await investigationAPI.getAssignedCases();
        if (response.status === 'success') {
            const cases = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>Crime Type</th>
                            <th>Assigned Date</th>
                            <th>Deadline</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (cases.length === 0) {
                html += '<tr><td colspan="7" style="text-align: center;">No investigations assigned yet</td></tr>';
            } else {
                cases.forEach(caseItem => {
                    const deadline = caseItem.deadline ? new Date(caseItem.deadline) : null;
                    const isOverdue = deadline && deadline < new Date();
                    
                    html += `
                        <tr ${isOverdue ? 'style="background: #fff3cd;"' : ''}>
                            <td><strong>${caseItem.case_number}</strong></td>
                            <td>${caseItem.crime_type}</td>
                            <td>${new Date(caseItem.assigned_date).toLocaleDateString()}</td>
                            <td ${isOverdue ? 'style="color: red; font-weight: bold;"' : ''}>
                                ${deadline ? deadline.toLocaleDateString() : 'No deadline'}
                                ${isOverdue ? ' (OVERDUE)' : ''}
                            </td>
                            <td>${getPriorityBadge(caseItem.priority)}</td>
                            <td>${getStatusBadge(caseItem.status)}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="manageInvestigation(${caseItem.id})">Manage</button>
                                <button class="btn btn-sm btn-secondary" onclick="viewCaseDetails(${caseItem.id})">Details</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#investigationsTable').html(html);
        }
    } catch (error) {
        $('#investigationsTable').html('<div class="alert alert-error">Failed to load investigations: ' + error.message + '</div>');
    }
}

function manageInvestigation(caseId) {
    // Get user role
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    const userRole = userData.role;
    
    // Only investigators get the full-page modal
    if (userRole === 'investigator' && typeof showFullCaseDetailsModal === 'function') {
        showFullCaseDetailsModal(caseId);
        return;
    }
    
    // Fallback to old implementation if modal not loaded
    $('#pageTitle').text('Manage Investigation');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="loadInvestigationsPage()">
                <i class="fas fa-arrow-left"></i> Back to Investigations
            </button>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="showInvestigationTab('evidence', ${caseId})">Evidence</button>
            <button class="tab-btn" onclick="showInvestigationTab('reports', ${caseId})">Reports</button>
            <button class="tab-btn" onclick="showInvestigationTab('timeline', ${caseId})">Timeline</button>
        </div>
        
        <div id="investigationTabContent">
            Loading...
        </div>
    `);
    
    showInvestigationTab('evidence', caseId);
}

function showInvestigationTab(tab, caseId) {
    $('.tab-btn').removeClass('active');
    $(`.tab-btn:contains('${tab.charAt(0).toUpperCase() + tab.slice(1)}')`).addClass('active');
    
    const content = $('#investigationTabContent');
    
    switch(tab) {
        case 'evidence':
            loadCaseEvidence(caseId);
            break;
        case 'reports':
            loadCaseReports(caseId);
            break;
        case 'timeline':
            loadCaseTimeline(caseId);
            break;
    }
}

async function loadCaseEvidence(caseId) {
    const content = $('#investigationTabContent');
    content.html(`
        <div style="margin: 20px 0;">
            <button class="btn btn-primary" onclick="uploadEvidence(${caseId})">
                <i class="fas fa-upload"></i> Upload Evidence
            </button>
        </div>
        <div id="evidenceList">Loading evidence...</div>
    `);
    
    try {
        const response = await investigationAPI.getCaseEvidence(caseId);
        if (response.status === 'success') {
            const evidence = response.data;
            let html = '<table class="data-table"><thead><tr><th>Evidence #</th><th>Type</th><th>Description</th><th>Collected</th><th>Actions</th></tr></thead><tbody>';
            
            if (evidence.length === 0) {
                html += '<tr><td colspan="5" style="text-align: center;">No evidence uploaded yet</td></tr>';
            } else {
                evidence.forEach(item => {
                    html += `
                        <tr>
                            <td><strong>${item.evidence_number}</strong></td>
                            <td><span class="badge-status">${item.evidence_type}</span></td>
                            <td>${item.description ? item.description.substring(0, 50) + '...' : 'N/A'}</td>
                            <td>${item.collected_at ? new Date(item.collected_at).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewEvidenceDetails(${item.id})">View</button>
                                <button class="btn btn-sm btn-primary" onclick="evidenceEditManager.showEditModal(${item.id})"><i class="fas fa-edit"></i> Edit</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += '</tbody></table>';
            $('#evidenceList').html(html);
        }
    } catch (error) {
        $('#evidenceList').html('<div class="alert alert-error">Failed to load evidence</div>');
    }
}

async function loadCaseReports(caseId) {
    const content = $('#investigationTabContent');
    content.html(`
        <div style="margin: 20px 0;">
            <button class="btn btn-primary" onclick="createReport(${caseId})">
                <i class="fas fa-file-alt"></i> Create Report
            </button>
        </div>
        <div id="reportsList">Loading reports...</div>
    `);
    
    // Placeholder - shows empty state
    $('#reportsList').html(`
        <table class="data-table">
            <thead><tr><th>Report Type</th><th>Created</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
                <tr><td colspan="4" style="text-align: center;">No reports created yet</td></tr>
            </tbody>
        </table>
    `);
}

async function loadCaseTimeline(caseId) {
    const content = $('#investigationTabContent');
    content.html(`
        <div style="margin: 20px 0;">
            <button class="btn btn-primary" onclick="addTimelineEntry(${caseId})">
                <i class="fas fa-plus"></i> Add Timeline Entry
            </button>
        </div>
        <div id="timelineList">Loading timeline...</div>
    `);
    
    // Placeholder - shows empty state
    $('#timelineList').html(`
        <div class="timeline">
            <p style="text-align: center; color: #6b7280;">No timeline entries yet</p>
        </div>
    `);
}

function uploadEvidence(caseId) {
    const bodyHtml = `
        <form id="uploadEvidenceForm">
            <div class="form-group">
                <label>Evidence Type *</label>
                <select name="evidence_type" required>
                    <option value="photo">Photo</option>
                    <option value="video">Video</option>
                    <option value="audio">Audio</option>
                    <option value="document">Document</option>
                    <option value="physical">Physical Item</option>
                    <option value="digital">Digital Evidence</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea name="description" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label>Storage Location *</label>
                <input type="text" name="storage_location" required placeholder="e.g., Evidence Room A, Shelf 3">
            </div>
            <div class="form-group">
                <label>Collection Date *</label>
                <input type="datetime-local" name="collection_date" required>
            </div>
            <div class="form-group">
                <label>File Upload</label>
                <input type="file" name="evidence_file" id="evidenceFile">
                <small>For digital evidence (photos, videos, documents)</small>
            </div>
        </form>
    `;
    showModal('Upload Evidence', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Upload', class: 'btn btn-primary', onclick: `submitEvidence(${caseId})` }
    ]);
}

function createReport(caseId) {
    const bodyHtml = `
        <form id="createReportForm">
            <div class="form-group">
                <label>Report Type *</label>
                <select name="report_type" required>
                    <option value="preliminary">Preliminary Report</option>
                    <option value="interim">Interim Report</option>
                    <option value="final">Final Report</option>
                    <option value="court_submission">Court Submission</option>
                </select>
            </div>
            <div class="form-group">
                <label>Report Title *</label>
                <input type="text" name="title" required>
            </div>
            <div class="form-group">
                <label>Report Content *</label>
                <textarea name="content" rows="10" required placeholder="Write your report here..."></textarea>
            </div>
            <div class="form-group">
                <label>Findings</label>
                <textarea name="findings" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>Recommendations</label>
                <textarea name="recommendations" rows="4"></textarea>
            </div>
        </form>
    `;
    showModal('Create Investigation Report', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Save Draft', class: 'btn btn-secondary', onclick: `submitReport(${caseId}, 'draft')` },
        { text: 'Submit', class: 'btn btn-primary', onclick: `submitReport(${caseId}, 'submitted')` }
    ]);
}

function addTimelineEntry(caseId) {
    const bodyHtml = `
        <form id="timelineEntryForm">
            <div class="form-group">
                <label>Activity Type *</label>
                <select name="activity_type" required>
                    <option value="investigation">Investigation Activity</option>
                    <option value="interview">Interview</option>
                    <option value="evidence_collection">Evidence Collection</option>
                    <option value="site_visit">Site Visit</option>
                    <option value="meeting">Meeting</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date & Time *</label>
                <input type="datetime-local" name="activity_date" required>
            </div>
            <div class="form-group">
                <label>Activity Description *</label>
                <textarea name="description" rows="5" required placeholder="Describe what happened..."></textarea>
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" name="location">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" rows="3"></textarea>
            </div>
        </form>
    `;
    showModal('Add Timeline Entry', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Add Entry', class: 'btn btn-primary', onclick: `submitTimelineEntry(${caseId})` }
    ]);
}

async function submitEvidence(caseId) {
    const form = $('#uploadEvidenceForm')[0];
    const formData = new FormData(form);
    
    try {
        const response = await investigationAPI.uploadEvidence(caseId, formData);
        if (response.status === 'success') {
            alert('Evidence uploaded successfully!');
            closeModal();
            loadCaseEvidence(caseId);
        }
    } catch (error) {
        alert('Failed to upload evidence: ' + error.message);
    }
}

async function submitReport(caseId, status) {
    const form = $('#createReportForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.status = status;
    
    try {
        const response = await investigationAPI.createReport(caseId, data);
        if (response.status === 'success') {
            alert('Report created successfully!');
            closeModal();
            loadCaseReports(caseId);
        }
    } catch (error) {
        alert('Failed to create report: ' + error.message);
    }
}

async function submitTimelineEntry(caseId) {
    const form = $('#timelineEntryForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await investigationAPI.addTimelineEntry(caseId, data);
        if (response.status === 'success') {
            alert('Timeline entry added!');
            closeModal();
            loadCaseTimeline(caseId);
        }
    } catch (error) {
        alert('Failed to add timeline entry: ' + error.message);
    }
}

// Evidence Page
function loadEvidencePage() {
    $('#pageTitle').text('Evidence Management');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
            <input type="text" id="evidenceSearch" placeholder="Search by evidence number or case..." style="flex: 1; padding: 8px;">
            <select id="evidenceTypeFilter" style="padding: 8px;">
                <option value="">All Types</option>
                <option value="photo">Photo</option>
                <option value="video">Video</option>
                <option value="audio">Audio</option>
                <option value="document">Document</option>
                <option value="physical">Physical Item</option>
                <option value="digital">Digital Evidence</option>
            </select>
            <button class="btn btn-primary" onclick="filterEvidence()">Filter</button>
        </div>
        <div id="evidenceTable">Loading evidence...</div>
    `);
    
    loadEvidenceTable();
}

// Function to refresh evidence list (called after editing)
function refreshEvidenceList() {
    if (typeof loadEvidenceTable === 'function') {
        loadEvidenceTable();
    }
}

async function loadEvidenceTable(filters = {}) {
    try {
        const response = await investigationAPI.getEvidence(filters);
        if (response.status === 'success') {
            const evidence = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Evidence Number</th>
                            <th>Case Number</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Collection Date</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (evidence.length === 0) {
                html += '<tr><td colspan="8" style="text-align: center;">No evidence found</td></tr>';
            } else {
                evidence.forEach(item => {
                    const editedBadge = item.is_edited ? '<span class="badge badge-warning" title="This evidence has been edited"><i class="fas fa-edit"></i></span>' : '';
                    html += `
                        <tr>
                            <td><strong>${item.evidence_number}</strong> ${editedBadge}</td>
                            <td>${item.case_number}</td>
                            <td><span class="badge-status">${item.evidence_type}</span></td>
                            <td>${item.description ? item.description.substring(0, 50) + '...' : 'N/A'}</td>
                            <td>${item.collected_at ? new Date(item.collected_at).toLocaleDateString() : 'N/A'}</td>
                            <td>${item.location_collected || 'N/A'}</td>
                            <td>${item.is_critical ? '<span class="badge badge-danger">Critical</span>' : '<span class="badge badge-secondary">Normal</span>'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewEvidenceDetails(${item.id})">View</button>
                                <button class="btn btn-sm btn-primary" onclick="evidenceEditManager.showEditModal(${item.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-info" onclick="evidenceEditManager.showEditHistory(${item.id})"><i class="fas fa-history"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#evidenceTable').html(html);
        }
    } catch (error) {
        $('#evidenceTable').html('<div class="alert alert-error">Failed to load evidence: ' + error.message + '</div>');
    }
}

function filterEvidence() {
    const search = $('#evidenceSearch').val();
    const type = $('#evidenceTypeFilter').val();
    loadEvidenceTable({ search, type });
}

async function viewEvidenceDetails(evidenceId) {
    try {
        const response = await investigationAPI.getEvidence({ id: evidenceId });
        if (response.status === 'success' && response.data.length > 0) {
            const evidence = response.data[0];
            
            const bodyHtml = `
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Evidence Number</span>
                        <span class="info-value">${evidence.evidence_number}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Type</span>
                        <span class="info-value"><span class="badge-status">${evidence.evidence_type}</span></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value"><span class="badge-status">${evidence.status}</span></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Collection Date</span>
                        <span class="info-value">${new Date(evidence.collection_date).toLocaleString()}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Collected By</span>
                        <span class="info-value">${evidence.collected_by_name || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Storage Location</span>
                        <span class="info-value">${evidence.storage_location}</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Description</h3>
                    <p>${evidence.description}</p>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Chain of Custody</h3>
                    <p>${evidence.chain_of_custody || 'No custody records yet'}</p>
                </div>
                
                ${evidence.analysis_result ? `
                <div style="margin-top: 20px;">
                    <h3>Analysis Result</h3>
                    <p>${evidence.analysis_result}</p>
                </div>` : ''}
            `;
            
            showModal('Evidence Details', bodyHtml, [
                { text: 'Update Chain', class: 'btn btn-primary', onclick: `updateChainOfCustody(${evidenceId})` },
                { text: 'Close', class: 'btn btn-secondary', onclick: 'closeModal()' }
            ]);
        }
    } catch (error) {
        alert('Failed to load evidence details: ' + error.message);
    }
}

function updateChainOfCustody(evidenceId) {
    closeModal(); // Close details modal first
    
    const bodyHtml = `
        <form id="chainOfCustodyForm">
            <div class="form-group">
                <label>Action *</label>
                <select name="action" required>
                    <option value="collected">Collected</option>
                    <option value="transferred">Transferred</option>
                    <option value="analyzed">Analyzed</option>
                    <option value="stored">Stored</option>
                    <option value="disposed">Disposed</option>
                </select>
            </div>
            <div class="form-group">
                <label>Location *</label>
                <input type="text" name="location" required placeholder="Current location of evidence">
            </div>
            <div class="form-group">
                <label>Notes *</label>
                <textarea name="notes" rows="4" required placeholder="Describe what happened with this evidence"></textarea>
            </div>
            <div class="form-group">
                <label>Date & Time *</label>
                <input type="datetime-local" name="custody_date" required value="${new Date().toISOString().slice(0,16)}">
            </div>
        </form>
    `;
    
    showModal('Update Chain of Custody', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Update', class: 'btn btn-primary', onclick: `submitChainOfCustody(${evidenceId})` }
    ]);
}

async function submitChainOfCustody(evidenceId) {
    const form = $('#chainOfCustodyForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await api.post(`/investigation/evidence/${evidenceId}/custody-log`, data);
        if (response.status === 'success') {
            alert('Chain of custody updated successfully!');
            closeModal();
            loadEvidenceTable();
        }
    } catch (error) {
        alert('Failed to update chain of custody: ' + error.message);
    }
}

// Court Cases Page
function loadCourtCasesPage() {
    $('#pageTitle').text('Court Cases');
    const content = $('#pageContent');
    content.html(`
        <div id="courtCasesTable">Loading court cases...</div>
    `);
    
    loadCourtCasesTable();
}

async function loadCourtCasesTable() {
    try {
        const response = await courtAPI.getCourtCases();
        if (response.status === 'success') {
            const cases = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>Crime Type</th>
                            <th>Court Status</th>
                            <th>Submission Date</th>
                            <th>Court Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (cases.length === 0) {
                html += '<tr><td colspan="6" style="text-align: center;">No court cases found</td></tr>';
            } else {
                cases.forEach(caseItem => {
                    html += `
                        <tr>
                            <td><strong>${caseItem.case_number}</strong></td>
                            <td>${caseItem.crime_type}</td>
                            <td>${getStatusBadge(caseItem.status)}</td>
                            <td>${caseItem.submission_date ? new Date(caseItem.submission_date).toLocaleDateString() : '-'}</td>
                            <td>${caseItem.court_date ? new Date(caseItem.court_date).toLocaleDateString() : '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewCaseDetails(${caseItem.id})">View</button>
                                ${caseItem.status === 'escalated' ? '<button class="btn btn-sm btn-primary" onclick="submitToCourt(' + caseItem.id + ')">Submit</button>' : ''}
                                ${caseItem.status === 'court_pending' ? '<button class="btn btn-sm btn-success" onclick="uploadDecision(' + caseItem.id + ')">Decision</button>' : ''}
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#courtCasesTable').html(html);
        }
    } catch (error) {
        $('#courtCasesTable').html('<div class="alert alert-error">Failed to load court cases: ' + error.message + '</div>');
    }
}

function submitToCourt(caseId) {
    const bodyHtml = `
        <form id="courtSubmissionForm">
            <div class="form-group">
                <label>Court Name *</label>
                <input type="text" name="court_name" required placeholder="e.g., Kismayo District Court">
            </div>
            <div class="form-group">
                <label>Court Date *</label>
                <input type="date" name="court_date" required>
            </div>
            <div class="form-group">
                <label>Case File Number</label>
                <input type="text" name="case_file_number" placeholder="Court's file number">
            </div>
            <div class="form-group">
                <label>Prosecutor Name</label>
                <input type="text" name="prosecutor_name">
            </div>
            <div class="form-group">
                <label>Submission Notes</label>
                <textarea name="submission_notes" rows="4" placeholder="Any additional notes for court submission"></textarea>
            </div>
            <div class="form-group">
                <label>Attach Documents</label>
                <input type="file" name="documents" multiple>
                <small>Case file, evidence list, investigation reports</small>
            </div>
        </form>
    `;
    
    showModal('Submit Case to Court', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Submit to Court', class: 'btn btn-primary', onclick: `submitCourtCase(${caseId})` }
    ]);
}

async function submitCourtCase(caseId) {
    const form = $('#courtSubmissionForm')[0];
    const formData = new FormData(form);
    
    try {
        const response = await courtAPI.submitToCourt(caseId, formData);
        if (response.status === 'success') {
            alert('Case successfully submitted to court!');
            closeModal();
            loadCourtCasesTable();
        }
    } catch (error) {
        alert('Failed to submit to court: ' + error.message);
    }
}

function uploadDecision(caseId) {
    const bodyHtml = `
        <form id="courtDecisionForm">
            <div class="form-group">
                <label>Decision Type *</label>
                <select name="decision_type" required>
                    <option value="guilty">Guilty</option>
                    <option value="not_guilty">Not Guilty</option>
                    <option value="dismissed">Dismissed</option>
                    <option value="pending">Pending</option>
                    <option value="appeal">Appeal</option>
                </select>
            </div>
            <div class="form-group">
                <label>Decision Date *</label>
                <input type="date" name="decision_date" required>
            </div>
            <div class="form-group">
                <label>Verdict Summary *</label>
                <textarea name="verdict_summary" rows="5" required placeholder="Summarize the court's decision"></textarea>
            </div>
            <div class="form-group">
                <label>Sentence (if applicable)</label>
                <textarea name="sentence" rows="3" placeholder="Details of sentence if guilty verdict"></textarea>
            </div>
            <div class="form-group">
                <label>Upload Court Documents</label>
                <input type="file" name="decision_document" accept=".pdf,.doc,.docx">
                <small>Court order, judgment document (PDF format preferred)</small>
            </div>
        </form>
    `;
    
    showModal('Upload Court Decision', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Upload Decision', class: 'btn btn-success', onclick: `submitCourtDecision(${caseId})` }
    ]);
}

async function submitCourtDecision(caseId) {
    const form = $('#courtDecisionForm')[0];
    const formData = new FormData(form);
    
    try {
        const response = await courtAPI.uploadDecision(caseId, formData);
        if (response.status === 'success') {
            alert('Court decision uploaded successfully!');
            closeModal();
            loadCourtCasesTable();
        }
    } catch (error) {
        alert('Failed to upload decision: ' + error.message);
    }
}

// Custody Management Page
function loadCustodyPage() {
    $('#pageTitle').text('Custody Management');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="recordNewCustody()">
                <i class="fas fa-plus"></i> Record New Custody
            </button>
            <button class="btn btn-secondary" onclick="loadCustodyPage()">Active Only</button>
            <button class="btn btn-secondary" onclick="loadAllCustodyRecords()">View All</button>
        </div>
        <div id="custodyTable">Loading custody records...</div>
    `);
    
    loadCustodyTable();
}

async function loadCustodyTable() {
    try {
        const response = await obAPI.getActiveCustody();
        if (response.status === 'success') {
            const records = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Custody ID</th>
                            <th>Person Name</th>
                            <th>Case Number</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th>Custody Start</th>
                            <th>Expected Release</th>
                            <th>Health Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (records.length === 0) {
                html += '<tr><td colspan="9" style="text-align: center;">No active custody records</td></tr>';
            } else {
                records.forEach(record => {
                    const custodyStart = new Date(record.custody_start);
                    const expectedRelease = new Date(record.expected_release_date);
                    const now = new Date();
                    const isOverdue = expectedRelease < now;
                    
                    html += `
                        <tr ${isOverdue ? 'style="background: #fee2e2;"' : ''}>
                            <td><strong>#${record.id}</strong></td>
                            <td>${record.person_name}</td>
                            <td>${record.case_number || 'N/A'}</td>
                            <td><span class="badge-status ${record.custody_status === 'in_custody' ? 'pending' : 'approved'}">${record.custody_status}</span></td>
                            <td>${record.custody_location}<br><small>Cell: ${record.cell_number || 'N/A'}</small></td>
                            <td>${custodyStart.toLocaleString()}</td>
                            <td ${isOverdue ? 'style="color: red; font-weight: bold;"' : ''}>
                                ${expectedRelease.toLocaleString()}
                                ${isOverdue ? '<br><strong>(OVERDUE)</strong>' : ''}
                            </td>
                            <td><span class="badge-status ${record.health_status === 'good' ? 'approved' : 'pending'}">${record.health_status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="manageCustody(${record.id})">Manage</button>
                                <button class="btn btn-sm btn-secondary" onclick="addDailyLog(${record.id})">Daily Log</button>
                                <button class="btn btn-sm btn-warning" onclick="recordMovement(${record.id})">Movement</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#custodyTable').html(html);
        }
    } catch (error) {
        $('#custodyTable').html('<div class="alert alert-error">Failed to load custody records: ' + error.message + '</div>');
    }
}

function recordNewCustody() {
    const bodyHtml = `
        <form id="custodyForm">
            <div class="form-group">
                <label>Person Name *</label>
                <input type="text" name="person_name" required>
                <small>Search or enter new person</small>
            </div>
            <div class="form-group">
                <label>Case Number</label>
                <input type="text" name="case_number" placeholder="Optional - link to case">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Custody Location *</label>
                    <input type="text" name="custody_location" required>
                </div>
                <div class="form-group">
                    <label>Cell Number</label>
                    <input type="text" name="cell_number">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Custody Start *</label>
                    <input type="datetime-local" name="custody_start" required>
                </div>
                <div class="form-group">
                    <label>Expected Release</label>
                    <input type="datetime-local" name="expected_release_date">
                </div>
            </div>
            <div class="form-group">
                <label>Arrest Warrant Number</label>
                <input type="text" name="arrest_warrant_number">
            </div>
            <div class="form-group">
                <label>Initial Health Status *</label>
                <select name="health_status" required>
                    <option value="good">Good</option>
                    <option value="fair">Fair</option>
                    <option value="needs_attention">Needs Attention</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
        </form>
    `;
    showModal('Record New Custody', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Record', class: 'btn btn-primary', onclick: 'submitCustodyRecord()' }
    ]);
}

async function manageCustody(id) {
    try {
        const response = await obAPI.getCustody({ id: id });
        if (response.status === 'success' && response.data.length > 0) {
            const custody = response.data[0];
            
            const bodyHtml = `
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Person Name</span>
                        <span class="info-value">${custody.person_name}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Case Number</span>
                        <span class="info-value">${custody.case_number || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value"><span class="badge-status">${custody.custody_status}</span></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Location</span>
                        <span class="info-value">${custody.custody_location}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cell Number</span>
                        <span class="info-value">${custody.cell_number || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Health Status</span>
                        <span class="info-value"><span class="badge-status">${custody.health_status}</span></span>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Custody Period</h3>
                    <p>Start: ${new Date(custody.custody_start).toLocaleString()}<br>
                    Expected Release: ${custody.expected_release_date ? new Date(custody.expected_release_date).toLocaleString() : 'Not set'}</p>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Legal Information</h3>
                    <p>Arrest Warrant: ${custody.arrest_warrant_number || 'N/A'}<br>
                    Legal Time Limit: ${custody.legal_time_limit || 'N/A'} hours</p>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-sm btn-primary" onclick="closeModal(); addDailyLog(${id})">Add Daily Log</button>
                    <button class="btn btn-sm btn-warning" onclick="closeModal(); recordMovement(${id})">Record Movement</button>
                    <button class="btn btn-sm btn-success" onclick="releaseCustody(${id})">Release</button>
                </div>
            `;
            
            showModal('Custody Details', bodyHtml, [
                { text: 'Close', class: 'btn btn-secondary', onclick: 'closeModal()' }
            ]);
        }
    } catch (error) {
        alert('Failed to load custody details: ' + error.message);
    }
}

function releaseCustody(id) {
    if (confirm('Are you sure you want to release this person from custody?')) {
        alert('Releasing custody record #' + id);
        closeModal();
        loadCustodyTable();
    }
}

function addDailyLog(id) {
    const bodyHtml = `
        <form id="dailyLogForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Log Date *</label>
                    <input type="date" name="log_date" required value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label>Log Time *</label>
                    <input type="time" name="log_time" required value="${new Date().toTimeString().slice(0,5)}">
                </div>
            </div>
            <div class="form-group">
                <label>Health Status *</label>
                <select name="health_status" required>
                    <option value="good">Good</option>
                    <option value="fair">Fair</option>
                    <option value="needs_attention">Needs Attention</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="health_check_done" checked> Health Check Completed
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="meal_provided" checked> Meal Provided
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="exercise_allowed"> Exercise Allowed
                </label>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" rows="4"></textarea>
            </div>
        </form>
    `;
    showModal('Add Daily Log', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Save Log', class: 'btn btn-primary', onclick: `submitDailyLog(${id})` }
    ]);
}

function recordMovement(id) {
    const bodyHtml = `
        <form id="movementForm">
            <div class="form-group">
                <label>Movement Type *</label>
                <select name="movement_type" required>
                    <option value="court_appearance">Court Appearance</option>
                    <option value="hospital_visit">Hospital Visit</option>
                    <option value="transfer">Transfer to Another Center</option>
                    <option value="release">Release</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Movement Date *</label>
                    <input type="date" name="movement_date" required value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label>Movement Time *</label>
                    <input type="time" name="movement_time" required value="${new Date().toTimeString().slice(0,5)}">
                </div>
            </div>
            <div class="form-group">
                <label>Destination *</label>
                <input type="text" name="destination" required>
            </div>
            <div class="form-group">
                <label>Reason *</label>
                <textarea name="reason" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label>Escorted By</label>
                <input type="text" name="escorted_by">
            </div>
        </form>
    `;
    showModal('Record Movement', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Record', class: 'btn btn-primary', onclick: `submitMovement(${id})` }
    ]);
}

async function submitCustodyRecord() {
    const form = $('#custodyForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await obAPI.createCustody(data);
        if (response.status === 'success') {
            alert('Custody record created successfully!');
            closeModal();
            loadCustodyTable();
        }
    } catch (error) {
        alert('Failed to create custody record: ' + error.message);
    }
}

async function submitDailyLog(custodyId) {
    const form = $('#dailyLogForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.health_check_done = data.health_check_done ? 1 : 0;
    data.meal_provided = data.meal_provided ? 1 : 0;
    data.exercise_allowed = data.exercise_allowed ? 1 : 0;
    
    try {
        const response = await obAPI.addDailyLog(custodyId, data);
        if (response.status === 'success') {
            alert('Daily log added successfully!');
            closeModal();
            loadCustodyTable();
        }
    } catch (error) {
        alert('Failed to add daily log: ' + error.message);
    }
}

async function submitMovement(custodyId) {
    const form = $('#movementForm')[0];
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await obAPI.recordMovement(custodyId, data);
        if (response.status === 'success') {
            alert('Movement recorded successfully!');
            closeModal();
            loadCustodyTable();
        }
    } catch (error) {
        alert('Failed to record movement: ' + error.message);
    }
}

async function loadAllCustodyRecords() {
    $('#pageTitle').text('All Custody Records');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="loadCustodyPage()">
                <i class="fas fa-arrow-left"></i> Back to Active Only
            </button>
            <select id="custodyStatusFilter" style="margin-left: 10px; padding: 8px;">
                <option value="">All Statuses</option>
                <option value="in_custody">In Custody</option>
                <option value="released">Released</option>
                <option value="transferred">Transferred</option>
                <option value="court_appearance">Court Appearance</option>
            </select>
            <button class="btn btn-primary" onclick="filterAllCustody()">Filter</button>
        </div>
        <div id="allCustodyTable">Loading all custody records...</div>
    `);
    
    loadAllCustodyTable();
}

async function loadAllCustodyTable(status = '') {
    try {
        const response = await obAPI.getCustody({ status: status });
        if (response.status === 'success') {
            const records = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Person Name</th>
                            <th>Case Number</th>
                            <th>Status</th>
                            <th>Custody Start</th>
                            <th>Release/End Date</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (records.length === 0) {
                html += '<tr><td colspan="8" style="text-align: center;">No custody records found</td></tr>';
            } else {
                records.forEach(record => {
                    const startDate = new Date(record.custody_start);
                    const endDate = record.custody_end ? new Date(record.custody_end) : new Date();
                    const duration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)); // days
                    
                    html += `
                        <tr>
                            <td><strong>#${record.id}</strong></td>
                            <td>${record.person_name}</td>
                            <td>${record.case_number || 'N/A'}</td>
                            <td><span class="badge-status">${record.custody_status}</span></td>
                            <td>${startDate.toLocaleDateString()}</td>
                            <td>${record.custody_end ? new Date(record.custody_end).toLocaleDateString() : 'Ongoing'}</td>
                            <td>${duration} days</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="manageCustody(${record.id})">View</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#allCustodyTable').html(html);
        }
    } catch (error) {
        $('#allCustodyTable').html('<div class="alert alert-error">Failed to load custody records: ' + error.message + '</div>');
    }
}

function filterAllCustody() {
    const status = $('#custodyStatusFilter').val();
    loadAllCustodyTable(status);
}

// Case Assignments Page
function loadAssignmentsPage() {
    $('#pageTitle').text('Manage Case Assignments');
    const content = $('#pageContent');
    content.html(`
        <div class="page-header">
            <h2>Case Assignments</h2>
            <p>Assign investigators to approved cases</p>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3>Cases Ready for Assignment</h3>
            </div>
            <div class="card-body">
                <table id="assignmentsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>Crime Type</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Date Approved</th>
                            <th>Assigned Investigators</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assignmentsTableBody">
                        <tr><td colspan="7" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    `);
    
    loadAssignmentsTable();
}

async function loadAssignmentsTable() {
    try {
        // For now, we'll show all active assignments
        // In a real implementation, this would fetch from /station/assignments endpoint
        const response = await api.get('/station/cases/pending'); // Placeholder
        
        let html = `
            <h3>Active Case Assignments</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Case Number</th>
                        <th>Crime Type</th>
                        <th>Assigned To</th>
                        <th>Assigned Date</th>
                        <th>Deadline</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" style="text-align: center;">
                            No assignments data available yet.<br>
                            <small>This page will show case-to-investigator assignments.</small>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 30px;">
                <h3>Assign Cases to Investigators</h3>
                <p>Select a case from "All Cases" page and use the "Assign" button to assign investigators.</p>
            </div>
        `;
        
        $('#assignmentsTable').html(html);
    } catch (error) {
        $('#assignmentsTable').html('<div class="alert alert-info">Case assignment management - Coming soon!</div>');
    }
}

async function loadUnassignedCases() {
    $('#pageTitle').text('Unassigned Cases');
    const content = $('#pageContent');
    content.html(`
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="loadAssignmentsPage()">
                <i class="fas fa-arrow-left"></i> Back to Assignments
            </button>
        </div>
        <div id="unassignedCasesTable">Loading unassigned cases...</div>
    `);
    
    loadUnassignedCasesTable();
}

async function loadUnassignedCasesTable() {
    try {
        // Get approved cases that haven't been assigned yet
        const response = await obAPI.getCases({ status: 'approved' });
        if (response.status === 'success') {
            const cases = response.data;
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>Crime Type</th>
                            <th>Category</th>
                            <th>Priority</th>
                            <th>Incident Date</th>
                            <th>Days Waiting</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (cases.length === 0) {
                html += '<tr><td colspan="7" style="text-align: center;">No unassigned cases found</td></tr>';
            } else {
                cases.forEach(caseItem => {
                    const approvedDate = new Date(caseItem.approved_at || caseItem.created_at);
                    const daysWaiting = Math.floor((new Date() - approvedDate) / (1000 * 60 * 60 * 24));
                    
                    html += `
                        <tr ${daysWaiting > 7 ? 'style="background: #fff3cd;"' : ''}>
                            <td><strong>${caseItem.case_number}</strong></td>
                            <td>${caseItem.crime_type}</td>
                            <td><span class="badge-status">${caseItem.crime_category}</span></td>
                            <td>${getPriorityBadge(caseItem.priority)}</td>
                            <td>${new Date(caseItem.incident_date).toLocaleDateString()}</td>
                            <td ${daysWaiting > 7 ? 'style="color: red; font-weight: bold;"' : ''}>
                                ${daysWaiting} days
                                ${daysWaiting > 7 ? '<br><small>(URGENT)</small>' : ''}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="manageCaseAssignment(${caseItem.id})">Assign Now</button>
                                <button class="btn btn-sm btn-secondary" onclick="viewCaseDetails(${caseItem.id})">View</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            $('#unassignedCasesTable').html(html);
        }
    } catch (error) {
        $('#unassignedCasesTable').html('<div class="alert alert-error">Failed to load unassigned cases: ' + error.message + '</div>');
    }
}

// Reports Page
function loadReportsPage() {
    $('#pageTitle').text('Reports & Analytics');
    const content = $('#pageContent');
    content.html(`
        <div class="tabs">
            <button class="tab-btn active" onclick="showReportTab('statistics')">Statistics</button>
            <button class="tab-btn" onclick="showReportTab('cases')">Case Reports</button>
            <button class="tab-btn" onclick="showReportTab('performance')">Performance</button>
            <button class="tab-btn" onclick="showReportTab('custom')">Custom Reports</button>
        </div>
        <div id="reportTabContent"></div>
    `);
    
    showReportTab('statistics');
}

function showReportTab(tab) {
    $('.tab-btn').removeClass('active');
    $(`.tab-btn:contains('${tab.charAt(0).toUpperCase() + tab.slice(1)}')`).addClass('active');
    
    const content = $('#reportTabContent');
    
    switch(tab) {
        case 'statistics':
            loadStatisticsReport();
            break;
        case 'cases':
            loadCaseReports();
            break;
        case 'performance':
            loadPerformanceReport();
            break;
        case 'custom':
            loadCustomReports();
            break;
    }
}

function loadStatisticsReport() {
    const content = $('#reportTabContent');
    content.html(`
        <div style="margin: 20px 0;">
            <h3>System Statistics</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Total Cases</span>
                    <span class="info-value" id="statTotalCases">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Active Investigations</span>
                    <span class="info-value" id="statActiveInvestigations">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Pending Approval</span>
                    <span class="info-value" id="statPendingApproval">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Closed Cases</span>
                    <span class="info-value" id="statClosedCases">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Active Custody</span>
                    <span class="info-value" id="statActiveCustody">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total Evidence Items</span>
                    <span class="info-value" id="statTotalEvidence">Loading...</span>
                </div>
            </div>
        </div>
        
        <div style="margin: 30px 0;">
            <h3>Cases by Status</h3>
            <canvas id="casesByStatusChart" width="400" height="200"></canvas>
        </div>
        
        <div style="margin: 30px 0;">
            <h3>Cases by Crime Type</h3>
            <canvas id="casesByCrimeChart" width="400" height="200"></canvas>
        </div>
        
        <div style="margin: 20px 0; text-align: right;">
            <button class="btn btn-primary" onclick="exportStatisticsReport()">
                <i class="fas fa-download"></i> Export Report
            </button>
        </div>
    `);
    
    // Load statistics data
    loadStatisticsData();
}

async function loadStatisticsData() {
    try {
        const response = await api.get('/api/dashboard');
        if (response.status === 'success') {
            const stats = response.data.stats;
            $('#statTotalCases').text(stats.total_cases || 0);
            $('#statActiveInvestigations').text(stats.active_investigations || 0);
            $('#statPendingApproval').text(stats.pending_approval || 0);
            $('#statClosedCases').text(stats.closed_cases || 0);
            $('#statActiveCustody').text(stats.active_custody || 0);
            $('#statTotalEvidence').text(stats.total_evidence || 0);
            
            // Draw charts if Chart.js is available
            if (typeof Chart !== 'undefined') {
                drawCaseStatusChart(response.data.cases_by_status);
            }
        }
    } catch (error) {
        console.error('Failed to load statistics:', error);
    }
}

function drawCaseStatusChart(data) {
    const ctx = document.getElementById('casesByStatusChart');
    if (!ctx) return;
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(data || {}),
            datasets: [{
                label: 'Cases',
                data: Object.values(data || {}),
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function loadCaseReports() {
    const content = $('#reportTabContent');
    content.html(`
        <div style="margin: 20px 0;">
            <h3>Generate Case Report</h3>
            <form id="caseReportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Report Type</label>
                        <select name="report_type">
                            <option value="summary">Case Summary</option>
                            <option value="detailed">Detailed Case Report</option>
                            <option value="timeline">Case Timeline</option>
                            <option value="evidence">Evidence Report</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Range</label>
                        <select name="date_range">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status Filter</label>
                        <select name="status">
                            <option value="">All Statuses</option>
                            <option value="draft">Draft</option>
                            <option value="submitted">Submitted</option>
                            <option value="investigating">Investigating</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Crime Category</label>
                        <select name="category">
                            <option value="">All Categories</option>
                            <option value="violent">Violent Crime</option>
                            <option value="property">Property Crime</option>
                            <option value="drug">Drug Related</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-primary" onclick="generateCaseReport()">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="previewCaseReport()">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                </div>
            </form>
        </div>
    `);
}

function loadPerformanceReport() {
    const content = $('#reportTabContent');
    content.html(`
        <div style="margin: 20px 0;">
            <h3>Performance Metrics</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Average Case Resolution Time</span>
                    <span class="info-value">15 days</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Case Approval Rate</span>
                    <span class="info-value">92%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Investigation Success Rate</span>
                    <span class="info-value">78%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Court Submission Rate</span>
                    <span class="info-value">65%</span>
                </div>
            </div>
        </div>
        
        <div style="margin: 30px 0;">
            <h3>Investigator Performance</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Investigator</th>
                        <th>Assigned Cases</th>
                        <th>Completed</th>
                        <th>Pending</th>
                        <th>Success Rate</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" style="text-align: center;">Performance data will be calculated from actual case data</td>
                    </tr>
                </tbody>
            </table>
        </div>
    `);
}

function loadCustomReports() {
    const content = $('#reportTabContent');
    content.html(`
        <div style="margin: 20px 0;">
            <h3>Custom Report Builder</h3>
            <p>Build custom reports by selecting data fields and filters.</p>
            
            <form id="customReportForm">
                <div class="form-group">
                    <label>Report Name</label>
                    <input type="text" name="report_name" placeholder="Enter report name">
                </div>
                
                <div class="form-group">
                    <label>Select Data Fields</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <label><input type="checkbox" name="fields" value="case_number"> Case Number</label>
                        <label><input type="checkbox" name="fields" value="crime_type"> Crime Type</label>
                        <label><input type="checkbox" name="fields" value="status"> Status</label>
                        <label><input type="checkbox" name="fields" value="priority"> Priority</label>
                        <label><input type="checkbox" name="fields" value="incident_date"> Incident Date</label>
                        <label><input type="checkbox" name="fields" value="location"> Location</label>
                        <label><input type="checkbox" name="fields" value="investigator"> Investigator</label>
                        <label><input type="checkbox" name="fields" value="evidence_count"> Evidence Count</label>
                        <label><input type="checkbox" name="fields" value="outcome"> Outcome</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Output Format</label>
                    <select name="format">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-primary" onclick="generateCustomReport()">
                        <i class="fas fa-cog"></i> Generate Custom Report
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="saveReportTemplate()">
                        <i class="fas fa-save"></i> Save as Template
                    </button>
                </div>
            </form>
        </div>
    `);
}

function exportStatisticsReport() {
    alert('Exporting statistics report to PDF...');
}

function generateCaseReport() {
    alert('Generating case report based on selected filters...');
}

function previewCaseReport() {
    alert('Previewing case report...');
}

function generateCustomReport() {
    const form = $('#customReportForm')[0];
    const formData = new FormData(form);
    alert('Generating custom report with selected fields...');
}

function saveReportTemplate() {
    alert('Saving report template for future use...');
}

// ============================================
// Case Assignment Management Functions
// ============================================

async function loadAssignmentsTable() {
    try {
        const response = await stationAPI.getCases();
        if (response.status === 'success') {
            const cases = response.data;
            // Filter for approved cases
            const approvedCases = cases.filter(c => c.status === 'approved' || c.status === 'under_investigation');
            
            let html = '';
            if (approvedCases.length === 0) {
                html = '<tr><td colspan="7" class="text-center">No cases available for assignment</td></tr>';
            } else {
                approvedCases.forEach(caseItem => {
                    const investigators = caseItem.investigators || [];
                    const investigatorsList = investigators.length > 0
                        ? investigators.map(inv => `
                            <span class="badge-status ${inv.is_lead_investigator ? 'approved' : 'draft'}" style="margin: 2px;">
                                ${inv.full_name} ${inv.is_lead_investigator ? '(Lead)' : ''}
                            </span>
                        `).join('')
                        : '<span class="badge-status pending">No investigators assigned</span>';
                    
                    html += `
                        <tr>
                            <td><strong>${caseItem.case_number}</strong></td>
                            <td>${caseItem.crime_type}</td>
                            <td>${getPriorityBadge(caseItem.priority)}</td>
                            <td>${getStatusBadge(caseItem.status)}</td>
                            <td>${formatDate(caseItem.updated_at)}</td>
                            <td>${investigatorsList}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="showAssignInvestigatorModal(${caseItem.id}, '${caseItem.case_number}')">
                                    <i class="fas fa-user-plus"></i> Assign
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="viewCaseDetails(${caseItem.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            $('#assignmentsTableBody').html(html);
        }
    } catch (error) {
        $('#assignmentsTableBody').html(`<tr><td colspan="7" class="text-center text-danger">Error loading cases: ${error.message}</td></tr>`);
    }
}

// Show Assign Investigator Modal
async function showAssignInvestigatorModal(caseId, caseNumber) {
    // Load investigators
    let investigatorsOptions = '<option value="">Select Investigator</option>';
    try {
        const usersResponse = await adminAPI.getUsers();
        if (usersResponse.status === 'success') {
            const investigators = usersResponse.data.filter(u => u.role === 'investigator' && u.is_active);
            investigatorsOptions += investigators.map(inv => 
                `<option value="${inv.id}">${inv.full_name} (${inv.badge_number || 'N/A'})</option>`
            ).join('');
        }
    } catch (error) {
        console.error('Failed to load investigators:', error);
    }
    
    const bodyHtml = `
        <form id="assignInvestigatorForm">
            <div class="form-group">
                <label><strong>Case:</strong> ${caseNumber}</label>
            </div>
            
            <div class="form-group">
                <label>Investigator *</label>
                <select name="user_id" required>
                    ${investigatorsOptions}
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="is_lead_investigator"> Assign as Lead Investigator
                </label>
            </div>
            
            <div class="form-group">
                <label>Assignment Notes</label>
                <textarea name="assignment_notes" rows="3" placeholder="Special instructions or notes for this assignment..."></textarea>
            </div>
        </form>
    `;
    
    showModal('Assign Investigator to Case', bodyHtml, [
        { text: 'Cancel', class: 'btn btn-secondary', onclick: 'closeModal()' },
        { text: 'Assign', class: 'btn btn-primary', onclick: `submitAssignInvestigator(${caseId})` }
    ]);
}

// Submit Assignment
async function submitAssignInvestigator(caseId) {
    const form = $('#assignInvestigatorForm')[0];
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.case_id = caseId;
    data.is_lead_investigator = data.is_lead_investigator ? 1 : 0;
    
    try {
        showLoading('Assigning Investigator', 'Please wait...');
        const response = await stationAPI.assignInvestigator(data);
        
        closeAlert();
        if (response.status === 'success') {
            await showSuccess('Success!', 'Investigator assigned successfully!');
            closeModal();
            loadAssignmentsTable();
        }
    } catch (error) {
        closeAlert();
        console.error('Assignment error:', error);
        
        if (error.status === 400 && error.response && error.response.messages) {
            const messages = error.response.messages;
            let errorText = '';
            
            if (typeof messages === 'object') {
                errorText = Object.values(messages).join('\n');
            } else {
                errorText = messages;
            }
            
            await Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                html: errorText.replace(/\n/g, '<br>'),
                confirmButtonColor: '#ef4444'
            });
        } else {
            await showError('Error', 'Failed to assign investigator: ' + error.message);
        }
    }
}

// ============================================
// Related Cases Functions
// ============================================

let selectedRelatedCases = [];
let searchTimeout = null;

async function searchRelatedCases(event) {
    const searchTerm = event.target.value.trim();
    
    if (searchTerm.length < 3) {
        $('#relatedCasesResults').hide();
        return;
    }
    
    // Debounce search
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        try {
            const response = await obAPI.getCases();
            if (response.status === 'success') {
                const cases = response.data;
                
                // Filter cases based on search term
                const filteredCases = cases.filter(c => {
                    const searchLower = searchTerm.toLowerCase();
                    return (
                        c.case_number.toLowerCase().includes(searchLower) ||
                        c.crime_type.toLowerCase().includes(searchLower) ||
                        c.incident_description.toLowerCase().includes(searchLower)
                    );
                });
                
                displaySearchResults(filteredCases);
            }
        } catch (error) {
            console.error('Search error:', error);
        }
    }, 300);
}

function displaySearchResults(cases) {
    const resultsDiv = $('#relatedCasesResults');
    
    if (cases.length === 0) {
        resultsDiv.html('<p style="color: #6b7280; margin: 0;">No cases found</p>');
        resultsDiv.show();
        return;
    }
    
    let html = '<div style="font-size: 12px; color: #6b7280; margin-bottom: 10px;">Click to select related case:</div>';
    
    cases.forEach(caseItem => {
        // Don't show already selected cases
        if (selectedRelatedCases.includes(caseItem.id)) {
            return;
        }
        
        html += `
            <div class="search-result-item" onclick="addRelatedCase(${caseItem.id}, '${caseItem.case_number}', '${caseItem.crime_type}')" 
                 style="padding: 10px; border: 1px solid #e5e7eb; margin-bottom: 8px; border-radius: 4px; cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                <strong>${caseItem.case_number}</strong> - ${caseItem.crime_type}<br>
                <small style="color: #6b7280;">${caseItem.incident_description.substring(0, 80)}...</small><br>
                <small style="color: #9ca3af;">${getStatusBadge(caseItem.status)} | ${formatDate(caseItem.incident_date)}</small>
            </div>
        `;
    });
    
    resultsDiv.html(html);
    resultsDiv.show();
}

function addRelatedCase(caseId, caseNumber, crimeType) {
    if (selectedRelatedCases.includes(caseId)) {
        return;
    }
    
    selectedRelatedCases.push(caseId);
    displaySelectedCases();
    
    // Clear search
    $('#relatedCaseSearch').val('');
    $('#relatedCasesResults').hide();
}

function removeRelatedCase(caseId) {
    selectedRelatedCases = selectedRelatedCases.filter(id => id !== caseId);
    displaySelectedCases();
}

function displaySelectedCases() {
    const container = $('#selectedRelatedCases');
    
    if (selectedRelatedCases.length === 0) {
        container.html('');
        return;
    }
    
    let html = '<div style="margin-bottom: 15px;"><strong>Selected Related Cases:</strong></div>';
    
    selectedRelatedCases.forEach(caseId => {
        html += `
            <div style="display: inline-block; background: #eff6ff; border: 1px solid #3b82f6; padding: 8px 12px; border-radius: 20px; margin: 5px;">
                <span>Case #${caseId}</span>
                <button type="button" onclick="removeRelatedCase(${caseId})" 
                        style="background: none; border: none; color: #ef4444; margin-left: 8px; cursor: pointer; font-size: 16px;">
                    
                </button>
            </div>
        `;
    });
    
    container.html(html);
}


// Load related cases for case details view
async function loadRelatedCasesForView(caseId) {
    try {
        const response = await obAPI.getCaseRelationships(caseId);
        if (response.status === 'success' && response.data && response.data.length > 0) {
            const relatedCases = response.data;
            let html = '<div class="related-cases-list">';
            
            relatedCases.forEach(related => {
                html += `
                    <div class="related-case-item" style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="color: #3b82f6;">${related.case_number}</strong>
                                <span class="badge-status" style="margin-left: 10px;">${related.relationship_type}</span>
                                <p style="margin: 8px 0 0 0; color: #6b7280;">
                                    ${related.crime_type} | ${formatDate(related.incident_date)}
                                </p>
                                ${related.notes ? `<p style="margin: 5px 0 0 0; font-size: 13px; color: #9ca3af;"><em>${related.notes}</em></p>` : ''}
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="viewCaseDetails(${related.related_case_id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            $('#relatedCasesContent').html(html);
        } else {
            $('#relatedCasesSection').hide();
        }
    } catch (error) {
        console.error('Failed to load related cases:', error);
        $('#relatedCasesSection').hide();
    }
}



// ============================================
// OB Entry Page - Create New Cases
// ============================================

// OB Entry Page
function loadOBEntryPage() {
    $('#pageTitle').text('OB Entry - Create New Case');
    const content = $('#pageContent');
    content.html(`
        <div class="ob-entry-container">
            <div class="ob-entry-header">
                <h2><i class="fas fa-file-alt"></i> Create New Case</h2>
                <p>Enter case details and add parties (Accuser, Accused, Witnesses) with photos</p>
            </div>
            
            <form id="obEntryForm" class="ob-entry-form">
                <!-- Case Information -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-info-circle"></i> Case Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Crime Type <span class="required">*</span></label>
                            <input type="text" name="crime_type" required placeholder="e.g., Theft, Assault">
                        </div>
                        <div class="form-group">
                            <label>Crime Category <span class="required">*</span></label>
                            <select name="crime_category" required>
                                <option value="">Select Category</option>
                                <option value="violent">Violent Crimes</option>
                                <option value="property">Property Crimes</option>
                                <option value="drug">Drug Related</option>
                                <option value="cyber">Cybercrime</option>
                                <option value="sexual">Sexual Offenses</option>
                                <option value="juvenile">Juvenile Cases</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Incident Date <span class="required">*</span></label>
                            <input type="datetime-local" name="incident_date" required>
                        </div>
                        <div class="form-group">
                            <label>Priority <span class="required">*</span></label>
                            <select name="priority" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Incident Location <span class="required">*</span></label>
                        <input type="text" name="incident_location" required placeholder="Enter location">
                    </div>
                    
                    <div class="form-group">
                        <label>Incident Description <span class="required">*</span></label>
                        <textarea name="incident_description" required rows="4" placeholder="Describe what happened..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="is_sensitive"> Mark as Sensitive Case
                        </label>
                    </div>
                </div>
                
                <!-- Parties Section -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-users"></i> Case Parties</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">Add accuser and accused information (with photos if available)</p>
                    
                    <div class="parties-buttons">
                        <button type="button" class="btn btn-primary" onclick="addPartyToOBForm('accuser')">
                            <i class="fas fa-user-plus"></i> Add Accuser/Victim
                        </button>
                        <button type="button" class="btn btn-danger" onclick="addPartyToOBForm('accused')">
                            <i class="fas fa-user-times"></i> Add Accused
                        </button>
                        <button type="button" class="btn btn-info" onclick="addPartyToOBForm('witness')">
                            <i class="fas fa-user-tag"></i> Add Witness
                        </button>
                    </div>
                    
                    <div id="partiesList" class="parties-list-container">
                        <!-- Parties will be added here dynamically -->
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="navigateToPage('my-cases')">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Create Case
                    </button>
                </div>
            </form>
        </div>
        
        <style>
            .ob-entry-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
            .ob-entry-header { background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
            .ob-entry-header h2 { margin: 0 0 10px 0; font-size: 28px; }
            .ob-entry-header p { margin: 0; opacity: 0.9; }
            .ob-entry-form { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
            .form-section { margin-bottom: 40px; padding-bottom: 30px; border-bottom: 2px solid #e5e7eb; }
            .form-section:last-of-type { border-bottom: none; }
            .section-title { font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
            .section-title i { color: #3b82f6; }
            .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .form-group { margin-bottom: 20px; }
            .form-group label { display: block; font-weight: 600; color: #374151; margin-bottom: 8px; }
            .required { color: #ef4444; }
            .form-group input[type="text"], .form-group input[type="datetime-local"], .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
            .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
            .parties-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
            .party-item { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px; position: relative; }
            .party-item.accuser { border-left: 4px solid #10b981; }
            .party-item.accused { border-left: 4px solid #ef4444; }
            .party-item.witness { border-left: 4px solid #3b82f6; }
            .party-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
            .party-role-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
            .party-role-badge.accuser { background: #d1fae5; color: #065f46; }
            .party-role-badge.accused { background: #fee2e2; color: #991b1b; }
            .party-role-badge.witness { background: #dbeafe; color: #1e40af; }
            .party-remove { background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
            .party-remove:hover { background: #dc2626; }
            .party-details { display: grid; grid-template-columns: 100px 1fr; gap: 10px; font-size: 14px; }
            .party-details .label { font-weight: 600; color: #6b7280; }
            .party-details .value { color: #1f2937; }
            .party-photo-preview { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid #e5e7eb; }
            .form-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb; }
        </style>
    `);
    
    // Initialize empty parties array
    window.obEntryParties = [];
    renderOBEntryParties();
    
    // Form submission handler
    $('#obEntryForm').on('submit', async function(e) {
        e.preventDefault();
        await submitOBEntry();
    });
}

// Add party to OB Entry form
async function addPartyToOBForm(partyType) {
    const partyLabels = { 'accuser': 'Accuser/Victim', 'accused': 'Accused', 'witness': 'Witness' };
    
    const result = await Swal.fire({
        title: `Add ${partyLabels[partyType]}`,
        html: `
            <form id="addPartyFormOB" style="text-align: left;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 5px; display: block;">Photo</label>
                    <div style="text-align: center; margin-bottom: 10px;">
                        <div id="ob_party_photo_preview" style="display: none; margin-bottom: 10px;">
                            <img src="" alt="Photo preview" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid #e5e7eb;">
                        </div>
                        <input type="file" id="ob_party_photo" accept="image/*" onchange="previewOBPartyPhoto(event)" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <small style="color: #6b7280; font-size: 12px;">Max 5MB (JPG, PNG, GIF, WebP)</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>First Name <span style="color: red;">*</span></label>
                    <input type="text" id="ob_first_name" class="swal2-input" required style="width: 100%; margin: 5px 0;">
                </div>
                <div class="form-group">
                    <label>Middle Name</label>
                    <input type="text" id="ob_middle_name" class="swal2-input" style="width: 100%; margin: 5px 0;">
                </div>
                <div class="form-group">
                    <label>Last Name <span style="color: red;">*</span></label>
                    <input type="text" id="ob_last_name" class="swal2-input" required style="width: 100%; margin: 5px 0;">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select id="ob_gender" class="swal2-input" style="width: 100%; margin: 5px 0;">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>National ID</label>
                    <input type="text" id="ob_national_id" class="swal2-input" style="width: 100%; margin: 5px 0;">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="ob_phone" class="swal2-input" style="width: 100%; margin: 5px 0;">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="ob_address" class="swal2-textarea" style="width: 100%; margin: 5px 0; height: 80px;"></textarea>
                </div>
            </form>
        `,
        width: '600px',
        showCancelButton: true,
        confirmButtonText: `Add ${partyLabels[partyType]}`,
        preConfirm: () => {
            const firstName = document.getElementById('ob_first_name').value;
            const lastName = document.getElementById('ob_last_name').value;
            if (!firstName || !lastName) {
                Swal.showValidationMessage('First Name and Last Name are required');
                return false;
            }
            return {
                person_type: partyType,
                first_name: firstName,
                middle_name: document.getElementById('ob_middle_name').value,
                last_name: lastName,
                gender: document.getElementById('ob_gender').value || null,
                national_id: document.getElementById('ob_national_id').value || null,
                phone: document.getElementById('ob_phone').value || null,
                address: document.getElementById('ob_address').value || null,
                photoFile: document.getElementById('ob_party_photo').files[0] || null
            };
        }
    });
    
    if (result.isConfirmed) {
        window.obEntryParties.push(result.value);
        renderOBEntryParties();
    }
}

// Preview photo for OB Entry party
function previewOBPartyPhoto(event) {
    const file = event.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            Swal.showValidationMessage('File too large. Max 5MB');
            event.target.value = '';
            return;
        }
        if (!file.type.startsWith('image/')) {
            Swal.showValidationMessage('Please select a valid image file');
            event.target.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('ob_party_photo_preview');
            preview.querySelector('img').src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

// Render parties in OB Entry form
function renderOBEntryParties() {
    const container = $('#partiesList');
    const parties = window.obEntryParties || [];
    
    if (parties.length === 0) {
        container.html('<p style="color: #6b7280; text-align: center; padding: 20px;">No parties added yet. Click the buttons above to add accuser, accused, or witnesses.</p>');
        return;
    }
    
    let html = '';
    parties.forEach((party, index) => {
        const fullName = `${party.first_name} ${party.middle_name || ''} ${party.last_name}`.trim();
        const photoPreview = party.photoFile ? URL.createObjectURL(party.photoFile) : null;
        
        html += `
            <div class="party-item ${party.person_type}">
                <div class="party-header">
                    <span class="party-role-badge ${party.person_type}">${party.person_type.toUpperCase()}</span>
                    <button type="button" class="party-remove" onclick="removeOBEntryParty(${index})"><i class="fas fa-times"></i> Remove</button>
                </div>
                <div style="display: flex; gap: 20px;">
                    ${photoPreview ? `<img src="${photoPreview}" class="party-photo-preview" alt="${fullName}">` : ''}
                    <div class="party-details" style="flex: 1;">
                        <div class="label">Name:</div><div class="value">${fullName}</div>
                        ${party.gender ? `<div class="label">Gender:</div><div class="value">${party.gender}</div>` : ''}
                        ${party.national_id ? `<div class="label">ID:</div><div class="value">${party.national_id}</div>` : ''}
                        ${party.phone ? `<div class="label">Phone:</div><div class="value">${party.phone}</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    container.html(html);
}

// Remove party from OB Entry
function removeOBEntryParty(index) {
    window.obEntryParties.splice(index, 1);
    renderOBEntryParties();
}

// Submit OB Entry form
async function submitOBEntry() {
    const form = $('#obEntryForm')[0];
    if (!form.checkValidity()) { form.reportValidity(); return; }
    
    const parties = window.obEntryParties || [];
    if (parties.length === 0) {
        await showError('Missing Information', 'Please add at least one party (accuser or accused)');
        return;
    }
    
    try {
        showLoading('Creating Case', 'Please wait...');
        
        const formData = new FormData(form);
        const caseData = Object.fromEntries(formData);
        caseData.is_sensitive = formData.has('is_sensitive') ? 1 : 0;
        caseData.report_date = new Date().toISOString().slice(0, 19).replace('T', ' ');
        
        const caseResponse = await obAPI.createCase(caseData);
        
        if (caseResponse.status === 'success') {
            const caseId = caseResponse.data.id;
            
            for (const party of parties) {
                const partyFormData = new FormData();
                partyFormData.append('person_type', party.person_type);
                partyFormData.append('first_name', party.first_name);
                if (party.middle_name) partyFormData.append('middle_name', party.middle_name);
                partyFormData.append('last_name', party.last_name);
                if (party.gender) partyFormData.append('gender', party.gender);
                if (party.national_id) partyFormData.append('national_id', party.national_id);
                if (party.phone) partyFormData.append('phone', party.phone);
                if (party.address) partyFormData.append('address', party.address);
                if (party.photoFile) partyFormData.append('photo', party.photoFile);
                partyFormData.append('case_id', caseId);
                
                const token = localStorage.getItem('auth_token');
                await fetch(`${API_BASE_URL}/ob/persons`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: partyFormData
                });
            }
            
            closeAlert();
            await showSuccess('Success!', 'Case created successfully with all parties!');
            form.reset();
            window.obEntryParties = [];
            navigateToPage('my-cases');
        }
    } catch (error) {
        closeAlert();
        await showError('Error', 'Failed to create case: ' + (error.message || 'Unknown error'));
    }
}

// Load My Cases Page
function loadMyCasesPage() {
    $('#pageTitle').text('My Cases');
    $('#pageContent').html('<div style="margin-bottom: 20px;"><button class="btn btn-primary" onclick="navigateToPage(\'ob-entry\')"><i class="fas fa-plus"></i> Create New Case</button></div><div id="myCasesTable">Loading...</div>');
    loadMyCasesTable();
}

async function loadMyCasesTable() {
    try {
        const response = await obAPI.getMyCases();
        if (response.status === 'success') {
            const cases = response.data;
            let html = '<table class="data-table"><thead><tr><th>Case Number</th><th>Crime Type</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            if (cases.length === 0) {
                html += '<tr><td colspan="4" style="text-align: center;">No cases found</td></tr>';
            } else {
                cases.forEach(c => {
                    html += `<tr><td><strong>${c.case_number}</strong></td><td>${c.crime_type}</td><td>${getStatusBadge(c.status)}</td><td><button class="btn btn-sm" onclick="viewCaseDetails(${c.id})">View</button></td></tr>`;
                });
            }
            html += '</tbody></table>';
            $('#myCasesTable').html(html);
        }
    } catch (error) {
        $('#myCasesTable').html('<div class="alert alert-error">Failed to load cases</div>');
    }
}
