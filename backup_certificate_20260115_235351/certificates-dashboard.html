<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificates Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            padding: 0;
            margin: 0;
        }

        .dashboard-container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .create-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
        }

        .stat-card.total {
            border-left-color: #3b82f6;
        }

        .stat-card.today {
            border-left-color: #10b981;
        }

        .stat-card.week {
            border-left-color: #f59e0b;
        }

        .stat-card.month {
            border-left-color: #8b5cf6;
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }

        /* Search and Filter Bar */
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Certificates Table */
        .certificates-table {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
        }

        th {
            padding: 20px 20px;
            text-align: left;
            font-weight: 700;
            color: white;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        th:last-child {
            border-right: none;
        }

        td {
            padding: 20px 20px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            vertical-align: middle;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: linear-gradient(to right, #f0f9ff 0%, #ffffff 100%);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
            transform: scale(1.002);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .cert-number {
            font-weight: 700;
            color: #1e3a8a;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .person-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 15px;
        }

        .cert-date {
            color: #6b7280;
            font-size: 13px;
        }

        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-right: 6px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .action-btn i {
            font-size: 14px;
        }

        .btn-view {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-view:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .btn-edit {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        .btn-print {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-print:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        .btn-delete {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-delete:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 64px;
            color: #d1d5db;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #6b7280;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #9ca3af;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-expired {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-certificate"></i> Non-Criminal Certificates Dashboard
            </h1>
            <button class="create-btn" onclick="createNewCertificate()">
                <i class="fas fa-plus-circle"></i> Create New Certificate
            </button>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-icon" style="color: #3b82f6;">
                    <i class="fas fa-certificate"></i>
                </div>
                <div class="stat-value" id="totalCerts">0</div>
                <div class="stat-label">Total Certificates</div>
            </div>

            <div class="stat-card today">
                <div class="stat-icon" style="color: #10b981;">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-value" id="todayCerts">0</div>
                <div class="stat-label">Issued Today</div>
            </div>

            <div class="stat-card week">
                <div class="stat-icon" style="color: #f59e0b;">
                    <i class="fas fa-calendar-week"></i>
                </div>
                <div class="stat-value" id="weekCerts">0</div>
                <div class="stat-label">This Week</div>
            </div>

            <div class="stat-card month">
                <div class="stat-icon" style="color: #8b5cf6;">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-value" id="monthCerts">0</div>
                <div class="stat-label">This Month</div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="filter-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="üîç Search by name, reference number..." onkeyup="searchCertificates()">
            
            <select class="filter-select" id="dateFilter" onchange="filterCertificates()">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
            </select>

            <select class="filter-select" id="statusFilter" onchange="filterCertificates()">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="expired">Expired</option>
            </select>

            <button class="create-btn" onclick="refreshDashboard()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 10px 20px; font-size: 14px;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <!-- Certificates Table -->
        <div class="certificates-table">
            <table>
                <thead>
                    <tr>
                        <th>Reference Number</th>
                        <th>Person Name</th>
                        <th>Date of Birth</th>
                        <th>Issue Date</th>
                        <th>Validity</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="certificatesTableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            <div>Loading certificates...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        async function loadDashboardData() {
            // Load from backend API instead of localStorage
            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/investigation/certificates`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                console.log('üìã Dashboard: Loaded certificates from backend:', result);
                
                if (result.status !== 'success' || !result.data) {
                    throw new Error('Failed to load certificates');
                }
                
                const certificates = result.data;
            
            // Store globally for other functions
            window.currentCertificates = certificates;
            
            // Update statistics using correct IDs
            const today = new Date().toDateString();
            const todayCount = certificates.filter(c => new Date(c.created_at).toDateString() === today).length;
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekCount = certificates.filter(c => new Date(c.created_at) >= weekAgo).length;
            
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthCount = certificates.filter(c => new Date(c.created_at) >= monthAgo).length;
            
            document.getElementById('totalCerts').textContent = certificates.length;
            document.getElementById('todayCerts').textContent = todayCount;
            document.getElementById('weekCerts').textContent = weekCount;
            document.getElementById('monthCerts').textContent = monthCount;
            
            // Display table
            renderCertificateTable(certificates);
            
        } catch (error) {
            console.error('‚ùå Error loading certificates:', error);
            document.getElementById('totalCerts').textContent = '0';
            document.getElementById('todayCerts').textContent = '0';
            document.getElementById('weekCerts').textContent = '0';
            document.getElementById('monthCerts').textContent = '0';
            
            const tableBody = document.getElementById('certificatesTableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 10px; display: block;"></i>
                            <p style="font-size: 16px; font-weight: 600;">Error loading certificates from database</p>
                            <p style="font-size: 14px;">${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }
    }

        function renderCertificateTable(certificates) {
            const tbody = document.getElementById('certificatesTableBody');
            
            if (!tbody) {
                console.error('Table body element not found');
                return;
            }
            
            if (certificates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No certificates found</td></tr>';
                return;
            }
            
            let html = '';
            certificates.forEach((cert, index) => {
                const issueDate = new Date(cert.issue_date);
                const birthDate = cert.birth_date ? new Date(cert.birth_date).toLocaleDateString() : 'N/A';
                const validity = cert.validity_period || 'N/A';
                const statusBadge = cert.is_active 
                    ? '<span class="badge badge-success">Active</span>' 
                    : '<span class="badge badge-warning">Inactive</span>';
                
                html += `
                    <tr>
                        <td class="cert-number">${cert.certificate_number}</td>
                        <td class="person-name">${cert.person_name}</td>
                        <td class="cert-date">${birthDate}</td>
                        <td class="cert-date">${new Date(cert.issue_date).toLocaleDateString()}</td>
                        <td class="cert-date">${validity}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn btn-view" onclick="viewCertificate(${index})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn btn-edit" onclick="editCertificate(${cert.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn btn-print" onclick="printCertificate(${cert.id})" title="Print">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteCertificate(${cert.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateStatistics(certificates) {
            const total = certificates.length;
            const today = new Date().toDateString();
            const todayCount = certificates.filter(c => new Date(c.created_at).toDateString() === today).length;
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekCount = certificates.filter(c => new Date(c.saved_at) >= weekAgo).length;
            
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthCount = certificates.filter(c => new Date(c.saved_at) >= monthAgo).length;
            
            document.getElementById('totalCerts').textContent = total;
            document.getElementById('todayCerts').textContent = todayCount;
            document.getElementById('weekCerts').textContent = weekCount;
            document.getElementById('monthCerts').textContent = monthCount;
        }

        function displayCertificatesTable(certificates) {
            const tbody = document.getElementById('certificatesTableBody');
            
            if (certificates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-certificate"></i>
                            <h3>No Certificates Yet</h3>
                            <p>Click "Create New Certificate" to issue your first certificate</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            certificates.reverse().forEach((cert, index) => {
                const actualIndex = certificates.length - 1 - index;
                const issueDate = new Date(cert.issue_date || cert.saved_at);
                const expiryDate = new Date(issueDate);
                expiryDate.setMonth(expiryDate.getMonth() + 6);
                
                const isExpired = new Date() > expiryDate;
                const statusBadge = isExpired ? 
                    '<span class="badge badge-expired">EXPIRED</span>' : 
                    '<span class="badge badge-active">ACTIVE</span>';
                
                const validityText = isExpired ? 
                    'Expired ' + Math.floor((new Date() - expiryDate) / (1000 * 60 * 60 * 24)) + ' days ago' :
                    'Expires in ' + Math.floor((expiryDate - new Date()) / (1000 * 60 * 60 * 24)) + ' days';
                
                html += `
                    <tr>
                        <td class="cert-number">${cert.ref_number || 'N/A'}</td>
                        <td class="person-name">${cert.person_name || 'Unknown'}</td>
                        <td class="cert-date">${cert.birth_date || 'N/A'}</td>
                        <td class="cert-date">${issueDate.toLocaleDateString()}</td>
                        <td class="cert-date">${validityText}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn btn-view" onclick="viewCertificate(${actualIndex})" title="View">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-btn btn-edit" onclick="editCertificate(${cert.id})" title="Edit">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn btn-print" onclick="printCertificate(${cert.id})" title="Print">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteCertificate(${cert.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function searchCertificates() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#certificatesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterCertificates() {
            const dateFilter = document.getElementById('dateFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let certificates = window.currentCertificates || [];
            
            // Date filter
            if (dateFilter !== 'all') {
                const now = new Date();
                const filterDate = new Date();
                
                switch(dateFilter) {
                    case 'today':
                        filterDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        filterDate.setDate(filterDate.getDate() - 7);
                        break;
                    case 'month':
                        filterDate.setMonth(filterDate.getMonth() - 1);
                        break;
                    case 'year':
                        filterDate.setFullYear(filterDate.getFullYear() - 1);
                        break;
                }
                
                certificates = certificates.filter(c => new Date(c.saved_at) >= filterDate);
            }
            
            // Status filter
            if (statusFilter !== 'all') {
                certificates = certificates.filter(c => {
                    const issueDate = new Date(c.issue_date || c.saved_at);
                    const expiryDate = new Date(issueDate);
                    expiryDate.setMonth(expiryDate.getMonth() + 6);
                    const isExpired = new Date() > expiryDate;
                    
                    return statusFilter === 'expired' ? isExpired : !isExpired;
                });
            }
            
            displayCertificatesTable(certificates);
        }

        function refreshDashboard() {
            loadDashboardData();
        }

        function createNewCertificate() {
            // Navigate to certificate form
            window.parent.postMessage({ action: 'navigate', page: 'non-criminal-certificate' }, '*');
        }

        function viewCertificate(index) {
            const certificates = window.currentCertificates || [];
            if (!certificates[index]) return;
            
            const cert = certificates[index];
            
            // Navigate to certificate page in view-only mode
            window.location.href = `non-criminal-certificate.html?view=${cert.id}`;
        }
        
        async function viewCertificateOLD(index) {
            const certificates = window.currentCertificates || [];
            if (!certificates[index]) return;
            
            const cert = certificates[index];
            
            // Open print-ready view in new window
            const printWindow = window.open('', '_blank', 'width=800,height=1000');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Certificate - ${cert.person_name}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        
                        body {
                            font-family: 'Segoe UI', Arial, sans-serif;
                            padding: 40px;
                            background: #f5f5f5;
                            margin: 0;
                        }
                        
                        .certificate-container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            padding: 60px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                            border: 2px solid #1e3a8a;
                            border-radius: 8px;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #1e3a8a;
                            padding-bottom: 30px;
                            margin-bottom: 40px;
                        }
                        
                        .header h1 {
                            color: #1e3a8a;
                            margin: 0 0 10px 0;
                            font-size: 32px;
                            font-weight: 700;
                            text-transform: uppercase;
                            letter-spacing: 2px;
                        }
                        
                        .header h2 {
                            color: #3b82f6;
                            margin: 0;
                            font-size: 24px;
                            font-weight: 600;
                        }
                        
                        .cert-number {
                            text-align: center;
                            font-size: 16px;
                            color: #6b7280;
                            margin-bottom: 30px;
                            font-weight: 600;
                        }
                        
                        .photo-section {
                            text-align: center;
                            margin: 30px 0;
                        }
                        
                        .photo-section img {
                            width: 180px;
                            height: 220px;
                            object-fit: cover;
                            border: 4px solid #1e3a8a;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        }
                        
                        .details-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 25px;
                            margin: 30px 0;
                        }
                        
                        .detail-item {
                            padding: 15px;
                            background: #f9fafb;
                            border-left: 4px solid #3b82f6;
                            border-radius: 4px;
                        }
                        
                        .detail-label {
                            font-size: 12px;
                            color: #6b7280;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            font-weight: 600;
                            margin-bottom: 5px;
                        }
                        
                        .detail-value {
                            font-size: 16px;
                            color: #1f2937;
                            font-weight: 600;
                        }
                        
                        .full-width {
                            grid-column: 1 / -1;
                        }
                        
                        .footer {
                            margin-top: 50px;
                            text-align: center;
                            padding-top: 30px;
                            border-top: 2px solid #e5e7eb;
                            color: #6b7280;
                            font-size: 14px;
                        }
                        
                        .print-buttons {
                            text-align: center;
                            margin: 30px 0;
                        }
                        
                        .print-btn {
                            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
                            color: white;
                            border: none;
                            padding: 15px 40px;
                            font-size: 16px;
                            font-weight: 600;
                            border-radius: 8px;
                            cursor: pointer;
                            margin: 0 10px;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                            transition: all 0.3s;
                        }
                        
                        .print-btn:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
                        }
                        
                        .close-btn {
                            background: #6b7280;
                        }
                        
                        .close-btn:hover {
                            background: #4b5563;
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-container">
                        <div class="header">
                            <h1>üèõÔ∏è Jubaland Police Force</h1>
                            <h2>Non-Criminal Certificate</h2>
                        </div>
                        
                        <div class="cert-number">
                            Certificate No: <strong>${cert.certificate_number}</strong>
                        </div>
                        
                        ${cert.photo_path ? `
                        <div class="photo-section">
                            <img src="${cert.photo_path}" alt="Photo">
                        </div>
                        ` : ''}
                        
                        <div class="details-grid">
                            <div class="detail-item full-width">
                                <div class="detail-label">Full Name</div>
                                <div class="detail-value">${cert.person_name || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">Mother's Name</div>
                                <div class="detail-value">${cert.mother_name || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">Gender</div>
                                <div class="detail-value">${cert.gender || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">Birth Date</div>
                                <div class="detail-value">${cert.birth_date ? new Date(cert.birth_date).toLocaleDateString() : 'N/A'}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">Birth Place</div>
                                <div class="detail-value">${cert.birth_place || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">Issue Date</div>
                                <div class="detail-value">${new Date(cert.issue_date).toLocaleDateString()}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">Validity Period</div>
                                <div class="detail-value">${cert.validity_period || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-item full-width">
                                <div class="detail-label">Purpose</div>
                                <div class="detail-value">${cert.purpose || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p><strong>Director: ${cert.director_name || 'Not specified'}</strong></p>
                            <p>Issued on ${new Date(cert.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    
                    <div class="print-buttons no-print">
                        <button class="print-btn" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Certificate
                        </button>
                        <button class="print-btn close-btn" onclick="window.close()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }

        function editCertificate(id) {
            // Navigate to certificate form with ID parameter
            window.location.href = `non-criminal-certificate.html?edit=${id}`;
        }

        async function printCertificate(id) {
            try {
                // Fetch certificate data
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/investigation/certificates/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    const cert = result.data;
                    
                    // Find index in current certificates for viewCertificate function
                    const index = window.currentCertificates.findIndex(c => c.id === id);
                    if (index !== -1) {
                        viewCertificate(index);
                    }
                } else {
                    alert('Failed to load certificate for printing');
                }
            } catch (error) {
                console.error('Error loading certificate:', error);
                alert('Error: ' + error.message);
            }
        }

        async function deleteCertificate(id) {
            if (!confirm('Delete this certificate from database?\\n\\nThis action cannot be undone.')) {
                return;
            }
            
            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/investigation/certificates/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('Certificate deleted successfully');
                    loadDashboardData(); // Reload from backend
                } else {
                    throw new Error(result.message || 'Failed to delete');
                }
            } catch (error) {
                console.error('‚ùå Error deleting certificate:', error);
                alert('Error deleting certificate: ' + error.message);
            }
        }
    </script>
</body>
</html>
